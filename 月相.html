<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€æœˆç›¸ç›ˆè™§</title>
    
    <style>
        /* =========================================
           1. Template 3.0 æ ¸å¿ƒæ¨£å¼
           ========================================= */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            background-color: #000;
            background-image: url('page.jpg'); 
            background-size: cover; background-position: center;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            color: #333;
        }

        .app-layout-wrapper {
            width: 100%; max-width: 600px; height: 100%;
            display: flex; flex-direction: column; position: relative;
            background: rgba(255,255,255,0.9); /* ç¨å¾®é€å‡ºèƒŒæ™¯ */
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .main-header {
            flex: 0 0 60px; width: 100%;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f, #fdbb2d);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex; align-items: center; padding: 0 15px; box-sizing: border-box;
            color: white;
        }
        .logo-area {
            width: 40px; height: 40px; background-color: white; border-radius: 50%;
            margin-right: 15px; background-image: url('logo.jpg'); background-size: cover;
            border: 2px solid #00d2ff; flex-shrink: 0;
        }
        .header-title {
            font-size: 1.1rem; font-weight: bold; color: white; line-height: 1.2; flex: 1;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .line-btn {
            background-color: #00B900; color: white; text-decoration: none;
            padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.5);
            white-space: nowrap; display: flex; align-items: center;
        }

        /* å…§å®¹æ²å‹•å€ */
        .content-scroll-area {
            flex: 1; overflow-y: auto; width: 100%; padding: 0 0 20px 0;
            display: flex; flex-direction: column; align-items: center;
            -webkit-overflow-scrolling: touch;
        }

        /* åº•éƒ¨æ§åˆ¶å¡¢ */
        .controls-dock {
            flex: 0 0 auto; width: 100%;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            padding: 8px 15px;
            box-sizing: border-box;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            display: flex; flex-direction: column; gap: 4px;
        }

        /* UI å¡ç‰‡æ¨£å¼ */
        .ui-card-style {
            width: 96%; max-width: 96%; box-sizing: border-box;
            margin: 10px auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 12px 20px;
            border-left: 8px solid #8e44ad; /* ä¿ç•™åŸæœˆç›¸ç´«è‰²é¢¨æ ¼ */
        }

        /* =========================================
           2. æœˆç›¸ç›ˆè™§ç‰¹å®šæ¨£å¼ (ä¿ç•™åŸè¦–è¦ºæ•ˆæœ)
           ========================================= */
        :root {
            --space-bg: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
        }

        /* æ¨¡æ“¬è¦–çª— wrapper (é«˜åº¦æ”¹ç‚º 500px) */
        #simWrapper {
            position: relative;
            width: 600px; 
            height: 500px; /* <--- Height increased to 500px */
            margin: 0 auto;
            flex-shrink: 0;
            overflow: hidden;
        }

        .simulation-container {
            position: absolute; top: 0; left: 0;
            width: 600px; 
            height: 500px; /* <--- Height increased to 500px */
            background: var(--space-bg);
            border-radius: 0 0 12px 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            overflow: hidden; 
            transform-origin: top left;
        }

        /* å¤ªé™½å…‰æŒ‡ç¤º */
        .sun-indicator-group {
            position: absolute; top: 45%; right: 15px; transform: translateY(-50%);
            display: flex; flex-direction: row; align-items: center; z-index: 5;
        }
        .sun-arrows-col { display: flex; flex-direction: column; gap: 5px; margin-right: 8px; }
        .arrow-icon { color: #f1c40f; font-size: 1rem; animation: pulseArrow 1.5s infinite; }
        .sun-text-col {
            writing-mode: vertical-rl; text-orientation: upright;
            color: #f1c40f; font-weight: bold; font-size: 1.1rem;
            text-shadow: 0 0 5px #d35400; letter-spacing: 5px;
        }
        @keyframes pulseArrow {
            0% { opacity: 0.4; transform: translateX(3px); }
            50% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0.4; transform: translateX(3px); }
        }

        /* ä¸­å¤®åœ°çƒèˆ‡è»Œé“ç³»çµ± */
        .system-center {
            position: absolute; top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border-radius: 50%; border: 2px dashed rgba(255,255,255,0.4); z-index: 5;
        }
        .earth-group {
            position: absolute; top: 50%; left: 50%;
            width: 80px; height: 80px; transform: translate(-50%, -50%); z-index: 10;
        }
        .earth-visual {
            width: 100%; height: 100%; border-radius: 50%; position: relative; overflow: hidden;
            background: radial-gradient(circle at 30% 30%, #4facfe 0%, #00f2fe 30%, #3498db 60%, #2980b9 100%);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.4); 
        }
        .earth-shadow-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.85) 50%, transparent 50%);
            border-radius: 50%; z-index: 2;
        }
        .time-marker {
            position: absolute; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: bold;
            text-shadow: 0 0 3px #000; white-space: nowrap; pointer-events: none;
        }
        .observer-container { position: absolute; top: 50%; left: 50%; width: 0; height: 0; z-index: 20; }
        .stickman { position: absolute; bottom: 40px; left: -3px; width: 6px; height: 25px; display: flex; flex-direction: column; align-items: center; }
        .stickman-head { width: 8px; height: 8px; background: white; border-radius: 50%; box-shadow: 0 0 3px black; }
        .stickman-body { width: 2px; height: 17px; background: white; box-shadow: 0 0 2px black; }

        /* æœˆçƒ */
        .moon-visual {
            position: absolute; top: 50%; left: 50%; width: 34px; height: 34px;
            margin-top: -17px; margin-left: -17px; border-radius: 50%;
            background: #dcdde1; box-shadow: 0 0 10px rgba(255,255,255,0.6);
            z-index: 15; overflow: hidden;
        }
        .moon-shadow-part {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.95) 50%, transparent 50%);
            border-radius: 50%;
        }
        .moon-label {
            position: absolute; top: 50%; left: 50%; color: #ddd; font-size: 12px; font-weight: bold;
            white-space: nowrap; text-shadow: 1px 1px 2px black; pointer-events: none; z-index: 16;
        }

        /* å·¦ä¸‹è§’ï¼šæœˆç›¸ç‰¹å¯« */
        .view-from-earth {
            position: absolute; bottom: 0px; left: 0px; width: 120px; height: 130px;
            background: rgba(20, 20, 30, 0.9);
            border-top: 1px solid rgba(255,255,255,0.2); border-right: 1px solid rgba(255,255,255,0.2);
            border-radius: 0 15px 0 0; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; z-index: 50; padding: 10px 5px 5px 5px; 
        }
        .view-title { color: #aaa; font-size: 11px; margin-bottom: 5px; text-align: center; white-space: nowrap; }
        .moon-phase-render {
            width: 65px; height: 65px; background-color: #050505; border-radius: 50%; position: relative;
            overflow: hidden; border: 1px solid #444; box-shadow: 0 0 10px rgba(255,255,255,0.05); margin-top: 5px;
        }
        .phase-svg { width: 100%; height: 100%; }
        .phase-path { fill: #fbfbf8; }
        .direction-labels {
            width: 100%; display: flex; justify-content: space-between; padding: 0 10px;
            box-sizing: border-box; margin-top: 2px;
        }
        .dir-tag { color: #f1c40f; font-weight: bold; font-size: 12px; }

        /* å³ä¸‹è§’ ç•¶æ—¥è»Œè·¡ */
        .view-horizon {
            position: absolute; bottom: 0px; right: 0px; width: 120px; height: 130px;
            background: rgba(20, 20, 30, 0.9);
            border-top: 1px solid rgba(255,255,255,0.2); border-left: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px 0 0 0; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; z-index: 50; padding: 10px 5px 5px 5px;
        }
        .horizon-stage {
            width: 100%; height: 80px; position: relative; border-bottom: 2px solid #555; 
            margin-top: 5px; overflow: hidden;
        }
        .horizon-moon {
            position: absolute; width: 20px; height: 20px; background: #050505; 
            border-radius: 50%; transform: translate(-50%, -50%); 
            box-shadow: 0 0 5px rgba(255,255,255,0.5); left: 50%; top: 120%; 
        }

        /* è³‡è¨Šé¢æ¿å…§å®¹æ¨£å¼ */
        .info-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 5px; min-height: 38px; 
        }
        .date-display { 
            font-size: 1.4rem; color: #444; font-weight: 900; 
            background: #f0f0f0; padding: 2px 10px; border-radius: 6px; 
        }
        .phase-name-group { display: flex; align-items: center; justify-content: flex-end; gap: 6px; }
        .phase-name { font-size: 1.4rem; font-weight: 900; color: #8e44ad; }
        .phenomenon-badge {
            background: #e74c3c; color: white; padding: 1px 4px; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; margin-left: 2px; white-space: nowrap;
        }
        .tide-badge {
            background: #2980b9; color: white; padding: 1px 4px; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; margin-left: 2px; white-space: nowrap;
        }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .info-item { 
            font-size: 0.95rem; color: #444; display: flex; align-items: center; line-height: 1.5;
			min-height: 45px;
        }
        .label {
            display: inline-block; width: 7em; white-space: nowrap;
            color: #555; font-weight: bold; margin-right: 5px; 
        }
        .highlight { color: #c0392b; font-weight: bold; }
        .blue-high { color: #2980b9; font-weight: bold; }
        .desc-wrapper {
            margin-top: 5px; font-size: 0.95rem; color: #444; 
            min-height: 4.6em; line-height: 1.5; display: flex; align-items: flex-start;
        }

        /* æ§åˆ¶é¢æ¿å…§å®¹æ¨£å¼ */
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        label { font-weight: bold; color: #555; min-width: 70px; font-size: 0.95rem;}
        input[type=range] { flex-grow: 1; cursor: pointer; height: 25px; accent-color: #8e44ad; }
        
        .btn-group { display: flex; gap: 5px; width: 100%; flex-wrap: wrap; margin-bottom: 5px;}
        .btn {
            flex: 1; padding: 8px 5px; border: 2px solid #ddd; border-radius: 6px;
            background: #fff; color: #555; font-weight: bold; cursor: pointer;
            transition: 0.2s; min-width: 60px; white-space: nowrap; 
        }
        .btn:hover { background: #eee; border-color: #bbb; }
        .btn.active { background: #8e44ad; color: white; border-color: #732d91; }

        .time-btn-group { display: flex; gap: 5px; width: 100%; margin-bottom: 2px; }
        .time-btn {
            flex: 1; padding: 5px; border: 1px solid #ccc; background: #fff;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
        }
        .time-btn:hover { background: #e0e0e0; }

        .btn-auto {
            background: #e67e22; color: white; border: none;
            border-radius: 4px; padding: 0 10px; height: 25px;
            margin-left: 5px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center; min-width: 30px;
        }
        .btn-auto:hover { background: #d35400; }
        .btn-auto.active { background: #c0392b; animation: pulseBtn 1s infinite; }

        .festival-select {
            flex: 0.8; padding: 8px 5px; border: 2px solid #ddd; border-radius: 6px;
            background: #fff; color: #555; font-weight: bold; cursor: pointer;
            text-align: center; font-size: 13.33px; 
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23444%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 3px top 50%; background-size: 8px auto; padding-right: 15px; 
        }
        @keyframes pulseBtn {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
            70% { box-shadow: 0 0 0 5px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }
		
		/* --- å¼·åˆ¶è¦†å¯«æ»‘æ¡¿æ¨£å¼ --- */
        
        /* é‡å° Chrome, Safari, Edge (æ‰‹æ©Ÿä¸»è¦æ ¸å¿ƒ) */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; /* æ¸…é™¤é è¨­æ¨£å¼ */
            appearance: none;
            
            /* è¨­å®šåœ“çƒå¤§å° */
            width: 20px; 
            height: 20px;
            
            /* è¨­å®šé¡è‰² (ä½¿ç”¨æ‚¨çš„ä¸»é¡Œç´«è‰²) */
            background: #8e44ad; 
            
            /* åŠ å€‹ç™½é‚Šè®“å®ƒåœ¨æ·±è‰²èƒŒæ™¯æ›´æ˜é¡¯ */
            border: 2px solid #fff; 
            border-radius: 50%; /* è®Šåœ“å½¢ */
            
            /* å¢åŠ é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            
            /* ä¿®æ­£å‚ç›´å°é½Š (è¦–æƒ…æ³å¾®èª¿) */
            margin-top: -8px; 
        }

        /* é‡å° Firefox (å‚™ç”¨) */
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #8e44ad;
            border: 2px solid #fff;
            border-radius: 50%;
            cursor: pointer;
        }

        /* é †ä¾¿æŠŠè»Œé“ (Track) ä¹Ÿä¿®é£¾ä¸€ä¸‹ï¼Œç¢ºä¿å‚ç›´ç½®ä¸­ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px; /* è»Œé“ç´°ä¸€é» */
            background: #ddd;
            border-radius: 2px;
        }

    </style>
</head>
<body>

    <div class="app-layout-wrapper">
        
        <header class="main-header">
            <a href="index.html" class="logo-area" title="è¿”å›å¤§å»³"></a>
            <div class="header-title">æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±<br>æœˆç›¸ç›ˆè™§</div>
            <a href="https://line.me/ti/g2/TTCqPpZP6lQqX1z_AUDPNm4977Dvylew3O7oBg" target="_blank" class="line-btn">
                åŠ  LINE è¨è«–
            </a>
        </header>

        <main class="content-scroll-area">
            
            <div id="simWrapper">
                <div class="simulation-container" id="simContainer">
                    
                    <div class="sun-indicator-group">
                        <div class="sun-arrows-col">
                            <div class="arrow-icon">â—€</div>
                            <div class="arrow-icon">â—€</div>
                            <div class="arrow-icon">â—€</div>
                        </div>
                        <div class="sun-text-col">å¤ªé™½å…‰</div>
                    </div>

                    <div class="system-center">
                        <div class="earth-group">
                            <div class="earth-visual">
                                <div class="earth-shadow-overlay"></div>
                            </div>
                            
                            <div class="observer-container" id="observerContainer">
                                <div class="stickman">
                                    <div class="stickman-head"></div>
                                    <div class="stickman-body"></div>
                                </div>
                            </div>
                        </div>

                        <div class="time-marker" style="top: 50%; right: 25px; transform: translateY(-50%);">12:00</div>
                        <div class="time-marker" style="top: 25px; left: 50%; transform: translateX(-50%);">18:00</div>
                        <div class="time-marker" style="top: 50%; left: 25px; transform: translateY(-50%);">24:00</div>
                        <div class="time-marker" style="bottom: 25px; left: 50%; transform: translateX(-50%);">06:00</div>

                        <div class="moon-visual" id="moonVisual">
                            <div class="moon-shadow-part" id="moonShadowFix"></div>
                        </div>
                        <div class="moon-label" id="moonLabel"></div>
                    </div>

                    <div class="view-from-earth" id="viewFromEarthPanel">
                        <div class="view-title">æœˆç›¸ç›ˆè™§ (é¢å‘å—æ–¹)</div>
                        <div class="moon-phase-render">
                            <svg class="phase-svg" viewBox="0 0 100 100">
                                <path id="phasePath" class="phase-path" d="" />
                            </svg>
                        </div>
                        <div class="direction-labels">
                            <span class="dir-tag">æ±</span>
                            <span class="dir-tag">è¥¿</span>
                        </div>
                    </div>

                    <div class="view-horizon" id="viewHorizonPanel">
                        <div class="view-title">ç•¶æ—¥è»Œè·¡ (é¢å‘å—æ–¹)</div>
                        <div class="horizon-stage">
                            <div class="horizon-moon" id="horizonMoon">
                                <svg class="phase-svg" viewBox="0 0 100 100">
                                    <path id="horizonPhasePath" class="phase-path" d="" />
                                </svg>
                            </div>
                        </div>
                        <div class="direction-labels">
                            <span class="dir-tag">æ±å‡</span>
                            <span class="dir-tag">è¥¿è½</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ui-card-style">
                <div class="info-header">
                    <span class="date-display" id="dateDisplay">è¾²æ›† åˆä¸€</span>
                    <div class="phase-name-group" id="phaseGroup">
                        <span class="phase-name" id="phaseName">æ–°æœˆ (æœ”)</span>
                    </div>
                </div>
                
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">ğŸŒ… æœˆå‡ºæ™‚åˆ»ï¼š</span>
                        <span class="highlight" id="moonRiseTime">06:00</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ğŸŒ„ æœˆè½æ™‚åˆ»ï¼š</span>
                        <span class="highlight" id="moonSetTime">18:00</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ğŸŒ“ æ˜æš—ç‹€æ³ï¼š</span>
                        <span class="blue-high" id="brightnessInfo">å…¨æš—</span>
                    </div>
                    <div class="info-item">
                        <span class="label">ğŸŒŸ ç‰¹æ®Šç¾è±¡ï¼š</span>
                        <span id="phenomenonDisplay">ç„¡</span>
                    </div>
                </div>
                
                <div class="desc-wrapper">
                    <span class="label">ğŸ’¡ èªªã€€ã€€æ˜ï¼š</span>
                    <span id="descText">æœˆçƒä½æ–¼åœ°çƒèˆ‡å¤ªé™½ä¸­é–“ï¼ŒèƒŒå…‰é¢å‘åœ°çƒã€‚</span>
                </div>
            </div>

        </main>
        
        <footer class="controls-dock">
            
            <div class="btn-group">
                <button class="btn" onclick="stopAllAnim(); setLunarDay(1)">åˆä¸€</button>
                <button class="btn" onclick="stopAllAnim(); setLunarDay(8.4)">åˆä¸ƒæˆ–åˆå…«</button>
                <button class="btn" onclick="stopAllAnim(); setLunarDay(15.8)">åäº”æˆ–åå…­</button>
                <button class="btn" onclick="stopAllAnim(); setLunarDay(23.1)">å»¿äºŒæˆ–å»¿ä¸‰</button>
                
                <select id="festivalSelect" class="festival-select" onchange="applyFestival(this.value)">
                    <option value="" disabled selected hidden>ç¯€æ—¥</option>
                    <option value="1">æ˜¥ç¯€</option>
                    <option value="15">å…ƒå®µ</option>
                    <option value="5">ç«¯åˆ</option>
                    <option value="7">ä¸ƒå¤•</option> 
                    <option value="15">ä¸­å…ƒ</option>
                    <option value="15">ä¸­ç§‹</option>
                    <option value="9">é‡é™½</option>
                    <option value="30">é™¤å¤•</option>
                </select>
            </div>
            
            <div class="control-row">
                <label>è¾²æ›†æ—¥æœŸ</label>
                <input type="range" id="daySlider" min="1" max="30" value="1" step="1" 
                       oninput="updateSim('manual')">
                <span id="dayVal" style="font-weight:bold; width: 40px; text-align:right;">1</span>
                <button class="btn-auto" id="btnAutoDay" onclick="toggleDayAnim()" title="è‡ªå‹•æ’­æ”¾æ—¥æœŸ">â–¶</button>
            </div>

            <div class="time-btn-group">
                 <button class="time-btn" onclick="setTime(6)">06:00</button>
                <button class="time-btn" onclick="setTime(12)">12:00</button>
                <button class="time-btn" onclick="setTime(18)">18:00</button>
                <button class="time-btn" onclick="setTime(24)">24:00</button>
            </div>

            <div class="control-row">
                <label>è§€æ¸¬æ™‚é–“</label>
                <input type="range" id="timeSlider" min="0" max="24" value="12" step="0.05" 
                       oninput="updateSim('manual')">
                <span id="timeVal" style="font-weight:bold; width: 40px; text-align:right;">12:00</span>
                <button class="btn-auto" id="btnAutoTime" onclick="toggleTimeAnim()" title="è‡ªå‹•æ’­æ”¾æ™‚é–“">â–¶</button>
            </div>
            
        </footer>

    </div>

    <script>
        function resizeSimulation() {
            const wrapper = document.getElementById('simWrapper');
            const simContainer = document.getElementById('simContainer');
            
            // ä½¿ç”¨ app-layout-wrapper ç¢ºä¿åœ¨ PC ç‰ˆä¹Ÿèƒ½æ­£ç¢ºå–å¾— 600px å¯¬åº¦
            const appWrapper = document.querySelector('.app-layout-wrapper');
            const availableWidth = Math.min(appWrapper.clientWidth, window.innerWidth) - 20; 

            if (availableWidth < 600) {
                const scale = availableWidth / 600;
                simContainer.style.transform = `scale(${scale})`;
                wrapper.style.width = `${600 * scale}px`;
                // â˜… Modified Height: 500px
                wrapper.style.height = `${500 * scale}px`;
            } else {
                simContainer.style.transform = 'none';
                wrapper.style.width = '600px';
                // â˜… Modified Height: 500px
                wrapper.style.height = '500px';
            }
        }
        window.addEventListener('resize', resizeSimulation);

        function setLunarDay(day) {
            document.getElementById('daySlider').value = day;
            updateSim('manual');
        }

        function setTime(hour) {
            document.getElementById('timeSlider').value = hour;
            updateSim('manual');
        }

        function applyFestival(val) {
            if(!val) return;
            stopAllAnim();
            setLunarDay(parseFloat(val));
        }

        // --- Animation Logic ---
        let dayAnim = null;
        let timeAnim = null;

        document.addEventListener('pointerdown', (e) => {
            if (!e.target.closest('.btn-auto')) {
                stopAllAnim();
            }
        });

        function stopAllAnim() {
            let stopped = false;
            if (dayAnim) {
                clearInterval(dayAnim);
                dayAnim = null;
                const dBtn = document.getElementById('btnAutoDay');
                dBtn.innerText = "â–¶";
                dBtn.classList.remove('active');
                stopped = true;
            }
            if (timeAnim) {
                clearInterval(timeAnim);
                timeAnim = null;
                const tBtn = document.getElementById('btnAutoTime');
                tBtn.innerText = "â–¶";
                tBtn.classList.remove('active');
                stopped = true;
            }
            if (stopped) {
                updateSim('manual');
            }
        }

        function toggleDayAnim() {
            const btn = document.getElementById('btnAutoDay');
            const wasActive = btn.classList.contains('active');
            
            stopAllAnim(); 

            if (!wasActive) {
                btn.innerText = "â– ";
                btn.classList.add('active');
                
                let currentVal = parseFloat(document.getElementById('daySlider').value);

                dayAnim = setInterval(() => {
                    // V22 Update: 12 seconds per cycle
                    currentVal += 0.1;
                    if (currentVal > 30.5) currentVal = 1;
                    updateSim('autoDay', currentVal);
                }, 40);
            }
        }

        function toggleTimeAnim() {
            const btn = document.getElementById('btnAutoTime');
            const wasActive = btn.classList.contains('active');
            
            stopAllAnim();

            if (!wasActive) {
                btn.innerText = "â– ";
                btn.classList.add('active');
                
                let currentVal = parseFloat(document.getElementById('timeSlider').value);

                timeAnim = setInterval(() => {
                    // V22 Update: 12 seconds per cycle
                    currentVal += 0.06;
                    if (currentVal >= 24) currentVal = 0;
                    
                    updateSim('autoTime', currentVal);
                }, 30);
            }
        }

        function updateSim(mode = 'manual', overrideVal = null) {
            let lunarDay = parseFloat(document.getElementById('daySlider').value);
            let timeHour = parseFloat(document.getElementById('timeSlider').value);

            if (mode === 'autoDay' && overrideVal !== null) {
                lunarDay = overrideVal;
                const sliderShow = (lunarDay > 30) ? 30 : lunarDay;
                document.getElementById('daySlider').value = sliderShow;
            }
            if (mode === 'autoTime' && overrideVal !== null) {
                timeHour = overrideVal;
                document.getElementById('timeSlider').value = timeHour;
            }
            
            document.getElementById('dayVal').innerText = Math.floor(lunarDay);
            document.getElementById('timeVal').innerText = formatTime(timeHour);

            // 1. æœˆçƒå…¬è½‰
            const moonAngle = ((lunarDay - 1) / 29.5) * 360; 
            const rad = moonAngle * (Math.PI / 180);
            const radius = 150; 
            const x = Math.cos(rad) * radius;
            const y = Math.sin(rad) * radius * -1; 

            const moonVisual = document.getElementById('moonVisual');
            const moonLabel = document.getElementById('moonLabel');
            moonVisual.style.transform = `translate(${x}px, ${y}px)`;
            moonLabel.style.transform = `translate(${x}px, ${y - 25}px) translateX(-50%)`;

            // 2. è§€æ¸¬è€…å…¬è½‰
            const obsRot = (timeHour - 12) * 15;
            const finalStickRot = 90 - obsRot; 
            document.getElementById('observerContainer').style.transform = `translate(-50%, -50%) rotate(${finalStickRot}deg)`;

            // 3. å³ä¸‹è§’è¦–çª—
            if (mode !== 'autoDay') {
                const earthRotationAngle = (timeHour - 12) * 15;
                updateHorizonView(moonAngle, earthRotationAngle, lunarDay);
            }

            // 4. è³‡è¨Šèˆ‡æœˆç›¸
            updateInfoPanel(lunarDay, moonAngle, timeHour);
            
            if (mode !== 'autoTime') {
                drawMoonPhase(lunarDay); 
            }
            
            // æŒ‰éˆ•ç‹€æ…‹é¡¯ç¤º
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(mode === 'manual') { 
                let dInt = Math.floor(lunarDay);
                
                if(Math.abs(lunarDay - 1) < 2) 
                    document.querySelectorAll('.btn')[0].classList.add('active');
                else if(dInt === 7 || dInt === 8) 
                    document.querySelectorAll('.btn')[1].classList.add('active');
                else if(dInt === 15 || dInt === 16) 
                    document.querySelectorAll('.btn')[2].classList.add('active');
                else if(dInt === 22 || dInt === 23) 
                    document.querySelectorAll('.btn')[3].classList.add('active');
            }
        }

        function updateHorizonView(moonOrbitAngle, observerAngle, day) {
            let delta = moonOrbitAngle - observerAngle;
            while(delta <= -180) delta += 360;
            while(delta > 180) delta -= 360;

            const moonElem = document.getElementById('horizonMoon');
            
            if (delta > -100 && delta < 100) {
                moonElem.style.display = 'block';
                const rad = delta * (Math.PI / 180);
                
                // xPos: +Delta is East (Left), -Delta is West (Right)
                const xPos = 50 - (Math.sin(rad) * 42); 
                const yPos = 100 - (Math.cos(rad) * 75); 
                
                moonElem.style.left = `${xPos}%`;
                moonElem.style.top = `${yPos}%`;
                
                // --- V26.1 Fix: Correct Field Rotation ---
                moonElem.style.transform = `translate(-50%, -50%) rotate(${-delta}deg)`;

            } else {
                moonElem.style.display = 'none';
            }

            drawMoonPhasePath(day, 'horizonPhasePath');
        }

        function updateInfoPanel(day, angle, currentHour) {
            let phase = "";
            let tide = "";
            let eclipse = "";
            let showTitle = false;

            let rise = 6;
            let set = 18;
            let brightDesc = "";
            let desc = "";

            let dayInt = Math.floor(day);

            // æ˜æš—ç‹€æ³
            if (dayInt >= 29 || dayInt <= 1) {
                brightDesc = "å…¨æš—";
            } 
            else if (dayInt >= 15 && dayInt <= 16) {
                brightDesc = "å…¨äº®";
            } 
            else if (dayInt >= 2 && dayInt <= 14) {
                brightDesc = "è¥¿äº®æ±æš—";
            } 
            else {
                brightDesc = "è¥¿æš—æ±äº®";
            }

            // æœˆç›¸åç¨±èˆ‡æè¿°
            if (day >= 29.5) {
                phase = "æ™¦æœˆ"; tide = "å¤§æ½®"; showTitle = true; rise = 6; set = 18;
                desc = "æœˆçƒé€±æœŸçš„æœ€å¾Œä¸€å¤©ï¼Œçœ‹ä¸è¦‹æœˆäº®ã€‚";
            } 
            else if (dayInt <= 1) { 
                phase = "æ–°æœˆ (æœ”)"; tide = "å¤§æ½®"; 
                if (Math.abs(day - 1) < 1.5) eclipse = "å¯èƒ½æ—¥é£Ÿ";
                showTitle = true; rise = 6; set = 18;
                desc = "æœˆçƒä½æ–¼åœ°çƒèˆ‡å¤ªé™½ä¸­é–“ï¼ŒèƒŒå…‰é¢å‘åœ°çƒã€‚ ç­åˆ¥ï¼šæ—©ç­æœˆäº®";
            } 
            else if (dayInt === 7 || dayInt === 8) { 
                phase = "ä¸Šå¼¦æœˆ"; tide = "å°æ½®"; showTitle = true; rise = 12; set = 24;
                desc = "ä¸­åˆå‡èµ·ï¼Œåˆå¤œè½ä¸‹ã€‚ ç­åˆ¥ï¼šåˆç­æœˆäº®";
            } 
            else if (dayInt === 15 || dayInt === 16) { 
                phase = "æ»¿æœˆ (æœ›)"; tide = "å¤§æ½®";
                if (Math.abs(day - 15) < 1.5) eclipse = "å¯èƒ½æœˆé£Ÿ";
                showTitle = true; rise = 18; set = 6;
                desc = "å¤ªé™½è¥¿è½ï¼Œæœˆçƒæ±æ˜‡ï¼Œæ•´å¤œå¯è¦‹ã€‚ ç­åˆ¥ï¼šæ™šç­æœˆäº®";
            } 
            else if (dayInt === 22 || dayInt === 23) { 
                phase = "ä¸‹å¼¦æœˆ"; tide = "å°æ½®"; showTitle = true; rise = 0; set = 12;
                desc = "åˆå¤œå‡èµ·ï¼Œä¸­åˆè½ä¸‹ã€‚ ç­åˆ¥ï¼šå¤§å¤œç­æœˆäº®";
            } 
            else {
                showTitle = false; 
                if (day < 7) {
                    phase = "çœ‰æœˆ"; tide = "ä¸­æ½®"; rise = 9; set = 21; desc = "å‚æ™šè¦‹æ–¼è¥¿æ–¹ä½ç©ºã€‚";
                } else if (day < 15) {
                    phase = "ç›ˆå‡¸æœˆ"; tide = "ä¸­æ½®"; rise = 15; set = 3; desc = "åˆå¾Œå‡èµ·ï¼Œå‡Œæ™¨è½ä¸‹ã€‚";
                } else if (day < 22) {
                    phase = "è™§å‡¸æœˆ"; tide = "ä¸­æ½®"; rise = 21; set = 9; desc = "å…¥å¤œå‡èµ·ï¼Œæ¸…æ™¨è¥¿æ–¹å¯è¦‹ã€‚";
                } else {
                    phase = "æ®˜æœˆ"; tide = "ä¸­æ½®"; rise = 3; set = 15; desc = "æ¸…æ™¨æ±æ–¹ä½ç©ºå¯è¦‹ã€‚";
                }
            }

            // æ¸²æŸ“
            let dayStr = "";
            const daysMap = ["", "åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", 
                             "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
                             "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
            if (dayInt <= 30) dayStr = daysMap[dayInt] || "";
            document.getElementById('dateDisplay').innerText = `è¾²æ›† ${dayStr}`;

            const phaseNameEl = document.getElementById('phaseName');
            if (showTitle) {
                phaseNameEl.innerText = phase;
                phaseNameEl.style.display = 'inline';
            } else {
                phaseNameEl.innerText = "";
                phaseNameEl.style.display = 'none';
            }

            const phenomEl = document.getElementById('phenomenonDisplay');
            if (showTitle) {
                 let content = "";
                 content += `<span class="tide-badge" style="background:${(tide=='å¤§æ½®'?'#c0392b':(tide=='å°æ½®'?'#27ae60':'#7f8c8d'))}">${tide}</span>`;
                 if(eclipse) {
                    content += ` <span class="phenomenon-badge">${eclipse}</span>`;
                 }
                 phenomEl.innerHTML = content;
            } else {
                 phenomEl.innerText = "ç„¡";
            }

            const buttonDates = [1, 7, 8, 15, 16, 22, 23];
            const showTimes = buttonDates.includes(dayInt);

            if(showTimes) {
                document.getElementById('moonRiseTime').innerText = formatTime(rise);
                document.getElementById('moonSetTime').innerText = formatTime(set);
            } else {
                document.getElementById('moonRiseTime').innerText = "";
                document.getElementById('moonSetTime').innerText = "";
            }

            document.getElementById('brightnessInfo').innerText = brightDesc;
            document.getElementById('descText').innerText = desc;
        }

        function formatTime(h) {
            h = h % 24;
            let hh = Math.floor(h);
            let mm = Math.floor((h - hh) * 60);
            return `${hh < 10 ? '0'+hh : hh}:${mm < 10 ? '0'+mm : mm}`;
        }

        function drawMoonPhase(day) {
            drawMoonPhasePath(day, 'phasePath');
        }

        function drawMoonPhasePath(day, targetId) {
            let cycle = (day - 1) / 29.5;
            if(cycle < 0) cycle = 0;
            if(cycle > 1) cycle = cycle % 1;

            const path = document.getElementById(targetId);
            let d = "";
            
            if (cycle <= 0.5) {
                if (cycle < 0.25) {
                    d = `M 50 0 A 50 50 0 0 1 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI)} 50 0 0 0 50 0`;
                } else {
                    d = `M 50 0 A 50 50 0 0 1 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI) * -1} 50 0 0 1 50 0`;
                }
            } else {
                if (cycle <= 0.75) {
                    d = `M 50 0 A 50 50 0 0 0 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI) * -1} 50 0 0 0 50 0`;
                } else {
                    d = `M 50 0 A 50 50 0 0 0 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI)} 50 0 0 1 50 0`;
                }
            }
            if (Math.abs(day - 15) < 0.5) d = "M 50 0 A 50 50 0 1 1 50 100 A 50 50 0 1 1 50 0";
            if (day < 1 || day > 29.5) d = "";

            path.setAttribute('d', d);
        }

        window.onload = function() {
            resizeSimulation();
            updateSim('manual');
        };

    </script>
</body>
</html>