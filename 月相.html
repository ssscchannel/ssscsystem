<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€æœˆç›¸ç›ˆè™§</title>
    <style>
        :root {
            --space-bg: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
            --panel-bg: rgba(255, 255, 255, 0.95);
            --highlight-color: #f1c40f;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #000; 
            background-image: url('page.jpg'), var(--space-bg);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            
            display: flex; flex-direction: column; align-items: center;
            margin: 0; padding: 5px; 
            min-height: 100vh;
            overflow-x: hidden; touch-action: manipulation;
            color: var(--text-color);
        }

        /* --- æ¨™é¡Œå€ (æ‰‹æ©Ÿç‰ˆç·Šæ¹ŠåŒ–) --- */
        .header-container {
            flex-shrink: 0; /* ç¦æ­¢è¢«å£“ç¸® */
            width: 97%;     /* ç¨å¾®ç•™é‚Š */
			box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒè®“å®ƒè®Šæ›´å¯¬ */
            max-width: 800px;
            
            /* è®“æ¨™é¡Œåœ¨å·¦ï¼ŒæŒ‰éˆ•åœ¨å³ */
            display: flex;
            justify-content: space-between; 
            align-items: center;
            
            /* è¦–è¦ºç¾åŒ– */
            padding: 8px 15px;
            margin-top: 5px;
			margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.9); /* 90% ä¸é€æ˜åº¦ */
            backdrop-filter: blur(5px);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* ç«‹é«”é™°å½± */
            z-index: 1000;
        }
		
        .title-logo {
            height: 36px; /* é™åˆ¶é«˜åº¦ï¼Œé¿å…æ’é–‹ */
            width: auto;
            border-radius: 4px;
        }
        .header-container h1 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
            line-height: 1.3;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px; /* Logo èˆ‡æ–‡å­—é–“è· */
        }
		
		/* =========================================
           3. å³ä¸Šè§’æŒ‰éˆ•ç¾¤ (æ–°åŠŸèƒ½)
           ========================================= */
        .nav-buttons {
            display: flex;
            gap: 8px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }
		
		/* ç²¾ç·»åŒ–çš„ LINE æŒ‰éˆ• (è† å›Šç‹€) */
        .header-btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            background: #06c755; /* LINE çš„å®˜æ–¹ç¶ è‰² */
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px; /* åœ“è§’è† å›Š */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s, background 0.2s;
            white-space: nowrap; /* ç¦æ­¢æ–‡å­—æ›è¡Œ */
        }
		
		.header-btn:active {
            transform: scale(0.95);
        }

        .header-btn span {
            margin-right: 4px; /* åœ–ç¤ºèˆ‡æ–‡å­—è·é›¢ */
        }

        /* --- æ–°å¢ï¼šå¤–éƒ¨é€£çµæŒ‰éˆ• (ç§»æ¤è‡ª index.html) --- */
        .external-link-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px; 
            text-decoration: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #fff;
            
            /* æ¨£å¼ä¿æŒä¸€è‡´ */
            padding: 6px 18px; 
            font-size: 0.9rem; 
            
            border-radius: 50px;
            font-weight: bold;
            /* å¾®èª¿ï¼šé‡å°æ­¤æª”æ¡ˆè¼ƒç·Šæ¹Šçš„ä½ˆå±€ï¼Œå°‡åŸ margin-bottom: 20px å¾®èª¿ç‚º 10px */
            margin-bottom: 10px;
            box-shadow: 0 3px 8px rgba(52, 152, 219, 0.4);
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .external-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(52, 152, 219, 0.6);
            background: linear-gradient(135deg, #2980b9 0%, #2c3e50 100%);
        }
        .external-link-btn:active {
            transform: scale(0.98);
        }

        /* --- ä¸»æ¨¡æ“¬è¦–çª— --- */
        #simWrapper {
            position: relative;
            width: 600px; height: 420px;
            margin: 0 auto;
        }

        .simulation-container {
            position: absolute; top: 0; left: 0;
            width: 600px; height: 420px;
            background: radial-gradient(circle at 50% 50%, #2c3e50 0%, #000000 90%);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            overflow: hidden; 
            transform-origin: top left;
        }

        /* å¤ªé™½å…‰æŒ‡ç¤º */
        .sun-indicator-group {
            position: absolute; 
            top: 45%;
            right: 15px;
            transform: translateY(-50%);
            display: flex; flex-direction: row;
            align-items: center;
            z-index: 5;
            background: none; border: none;
        }
        .sun-arrows-col {
            display: flex; flex-direction: column; gap: 5px;
            margin-right: 8px;
        }
        .arrow-icon {
            color: #f1c40f; font-size: 1rem; 
            animation: pulseArrow 1.5s infinite;
        }
        .sun-text-col {
            writing-mode: vertical-rl;
            text-orientation: upright;
            color: #f1c40f; font-weight: bold; font-size: 1.1rem;
            text-shadow: 0 0 5px #d35400; letter-spacing: 5px;
        }
        @keyframes pulseArrow {
            0% { opacity: 0.4; transform: translateX(3px); }
            50% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0.4; transform: translateX(3px); }
        }

        /* --- ä¸­å¤®åœ°çƒèˆ‡è»Œé“ç³»çµ± --- */
        .system-center {
            position: absolute; 
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            border-radius: 50%;
            border: 2px dashed rgba(255,255,255,0.4); 
            z-index: 5;
        }

        /* åœ°çƒ */
        .earth-group {
            position: absolute; top: 50%; left: 50%;
            width: 80px; height: 80px; 
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .earth-visual {
            width: 100%; height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at 30% 30%, #4facfe 0%, #00f2fe 30%, #3498db 60%, #2980b9 100%);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.4); 
        }
        
        .earth-shadow-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.85) 50%, transparent 50%);
            border-radius: 50%;
            z-index: 2;
        }

        /* æ™‚é–“æ–¹ä½æ¨™è¨˜ */
        .time-marker {
            position: absolute; 
            color: rgba(255,255,255,0.7); font-size: 14px; font-weight: bold;
            text-shadow: 0 0 3px #000;
            white-space: nowrap; pointer-events: none;
        }

        /* è§€æ¸¬è€… (ç«æŸ´äºº) */
        .observer-container {
            position: absolute; top: 50%; left: 50%;
            width: 0; height: 0;
            z-index: 20;
        }
        .stickman {
            position: absolute; 
            bottom: 40px;
            left: -3px;   
            width: 6px; height: 25px;
            display: flex; flex-direction: column; align-items: center;
        }
        .stickman-head {
            width: 8px; height: 8px; background: white; border-radius: 50%;
            box-shadow: 0 0 3px black;
        }
        .stickman-body {
            width: 2px; height: 17px; background: white;
            box-shadow: 0 0 2px black;
        }

        /* æœˆçƒ */
        .moon-visual {
            position: absolute; 
            top: 50%; left: 50%;
            width: 34px; height: 34px;
            margin-top: -17px; 
            margin-left: -17px;
            border-radius: 50%;
            background: #dcdde1; 
            box-shadow: 0 0 10px rgba(255,255,255,0.6);
            z-index: 15;
            overflow: hidden;
        }
        
        /* é™°å½±å±¤ */
        .moon-shadow-part {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.95) 50%, transparent 50%);
            border-radius: 50%;
        }
        
        /* æœˆçƒæ¨™ç±¤ */
        .moon-label {
            position: absolute; 
            top: 50%; left: 50%; 
            color: #ddd; font-size: 12px; font-weight: bold; white-space: nowrap;
            text-shadow: 1px 1px 2px black;
            pointer-events: none;
            z-index: 16;
        }

        /* --- å·¦ä¸‹è§’ï¼šæœˆç›¸ç‰¹å¯« --- */
        .view-from-earth {
            position: absolute; 
            bottom: 0px; left: 0px; 
            width: 120px; height: 130px;
            background: rgba(20, 20, 30, 0.9);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-right: 1px solid rgba(255,255,255,0.2);
            border-radius: 0 15px 0 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 50; 
            padding: 10px 5px 5px 5px; 
        }
        
        .view-title { 
            color: #aaa; font-size: 11px; margin-bottom: 5px; text-align: center;
            white-space: nowrap; /* PC é è¨­ä¸æŠ˜è¡Œ */
        }
        
        .moon-phase-render {
            width: 65px; height: 65px;
            background-color: #050505; 
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            border: 1px solid #444;
            box-shadow: 0 0 10px rgba(255,255,255,0.05);
            margin-top: 5px;
        }
        .phase-svg { width: 100%; height: 100%; }
        .phase-path { fill: #fbfbf8; }

        .direction-labels {
            width: 100%; display: flex; justify-content: space-between; padding: 0 10px;
            box-sizing: border-box; margin-top: 2px;
        }
        .dir-tag { color: #f1c40f; font-weight: bold; font-size: 12px; }

        /* --- å³ä¸‹è§’ ç•¶æ—¥è»Œè·¡ --- */
        .view-horizon {
            position: absolute; 
            bottom: 0px; right: 0px; 
            width: 120px; height: 130px;
            background: rgba(20, 20, 30, 0.9);
            border-top: 1px solid rgba(255,255,255,0.2);
            border-left: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px 0 0 0; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            z-index: 50; padding: 10px 5px 5px 5px;
        }
        
        /* è»Œè·¡é¡¯ç¤ºå€ */
        .horizon-stage {
            width: 100%; height: 80px;
            position: relative;
            border-bottom: 2px solid #555; 
            margin-top: 5px;
            overflow: hidden;
        }
        
        /* å‹•æ…‹æœˆçƒ */
        .horizon-moon {
            position: absolute;
            width: 20px; height: 20px; 
            background: #050505; 
            border-radius: 50%;
            transform: translate(-50%, -50%); 
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
            left: 50%; top: 120%; 
        }

        /* --- è³‡è¨Šé¢æ¿ --- */
        .info-card {
            width: 100%; max-width: 600px;
            background: white; padding: 12px 20px;
            box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 8px solid #8e44ad; 
            display: flex; flex-direction: column; gap: 6px;
        }

        .info-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; padding-bottom: 8px; margin-bottom: 5px;
            min-height: 38px; 
        }
        .date-display { 
            font-size: 1.4rem; color: #444; font-weight: 900; 
            background: #f0f0f0; padding: 2px 10px; border-radius: 6px; 
        }
        .phase-name-group {
            display: flex; align-items: center; justify-content: flex-end;
            gap: 6px;
        }
        .phase-name { font-size: 1.4rem; font-weight: 900; color: #8e44ad; }
        
        .phenomenon-badge {
            background: #e74c3c; color: white; padding: 1px 4px; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; margin-left: 2px; white-space: nowrap;
        }
        .tide-badge {
            background: #2980b9; color: white; padding: 1px 4px; border-radius: 4px;
            font-size: 0.8rem; font-weight: bold; margin-left: 2px; white-space: nowrap;
        }

        /* V24/V25 è³‡è¨Šç¶²æ ¼èˆ‡æ¨™ç±¤å°é½Šç³»çµ± */
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; 
            gap: 4px; 
        }
        
        /* V26 Update: çµ±ä¸€è³‡è¨Šæ ¼èˆ‡èªªæ˜æ¬„çš„å­—é«”ã€è¡Œé«˜èˆ‡é¡è‰² */
        .info-item { 
            font-size: 0.95rem; color: #444; 
            display: flex; align-items: center; 
            line-height: 1.5; /* çµ±ä¸€è¨­å®šè¡Œé«˜ */
        }
        
        /* æ¨™ç±¤ï¼šå›ºå®šå¯¬åº¦ä»¥ç¢ºä¿å†’è™Ÿå°é½Šï¼Œä¸¦å¼·åˆ¶ä¸æ›è¡Œ */
        .label {
            display: inline-block;
            width: 7em; 
            white-space: nowrap;
            color: #555;
            font-weight: bold;
            margin-right: 5px; 
        }
        
        .highlight { color: #c0392b; font-weight: bold; }
        .blue-high { color: #2980b9; font-weight: bold; }
        
        /* V26 Update: èªªæ˜å€å¡Šå®Œå…¨å°é½Šä¸Šæ–¹æ¨£å¼ */
        .desc-wrapper {
            margin-top: 5px; 
            font-size: 0.95rem; /* V26: èª¿æ•´ç‚ºèˆ‡ info-item ä¸€è‡´ (åŸ 0.9rem) */
            color: #444;        /* V26: èª¿æ•´ç‚ºèˆ‡ info-item ä¸€è‡´ (åŸ #666) */
            min-height: 2.8em; 
            line-height: 1.5;   /* V26: èª¿æ•´ç‚ºèˆ‡ info-item ä¸€è‡´ (åŸ 1.3) */
            display: flex; 
            align-items: flex-start; /* ä¿æŒé ‚éƒ¨å°é½Šä»¥é©æ‡‰å¤šè¡Œæ–‡å­— */
        }
        
        /* --- æ§åˆ¶å€ --- */
        .controls { 
            width: 100%; max-width: 600px;
            background: #f9f9f9; padding: 15px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            box-sizing: border-box; border-top: 1px solid #ddd;
        }
        .control-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
        label { font-weight: bold; color: #555; min-width: 70px; font-size: 0.95rem;}
        input[type=range] { flex-grow: 1; cursor: pointer; height: 25px; }

        .btn-group { display: flex; gap: 5px; width: 100%; flex-wrap: wrap; margin-bottom: 10px;}
        
        .btn {
            flex: 1; padding: 8px 5px; border: 2px solid #ddd; border-radius: 6px;
            background: #fff; color: #555; font-weight: bold; cursor: pointer;
            transition: 0.2s; min-width: 60px;
            white-space: nowrap; 
        }
        
        .btn:hover { background: #eee; border-color: #bbb; }
        .btn.active { background: #8e44ad; color: white; border-color: #732d91; }
        
        .time-btn-group { display: flex; gap: 5px; width: 100%; }
        .time-btn {
            flex: 1; padding: 5px; border: 1px solid #ccc; background: #fff;
            border-radius: 4px; cursor: pointer; font-size: 0.9rem;
        }
        .time-btn:hover { background: #e0e0e0; }
        
        .btn-auto {
            background: #e67e22; color: white; border: none;
            border-radius: 4px; padding: 0 10px; height: 25px;
            margin-left: 5px; cursor: pointer; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            min-width: 30px;
        }
        .btn-auto:hover { background: #d35400; }
        .btn-auto.active { background: #c0392b; animation: pulseBtn 1s infinite; }
        
        .festival-select {
            flex: 0.8; 
            padding: 8px 5px; border: 2px solid #ddd; border-radius: 6px;
            background: #fff; color: #555; font-weight: bold; cursor: pointer;
            text-align: center; font-size: 13.33px; 
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23444%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 3px top 50%;
            background-size: 8px auto;
            padding-right: 15px; 
        }
        .festival-select:hover { background-color: #eee; border-color: #bbb; }
        .festival-select:focus { outline: none; border-color: #8e44ad; }

        @keyframes pulseBtn {
            0% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.7); }
            70% { box-shadow: 0 0 0 5px rgba(192, 57, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(192, 57, 43, 0); }
        }

		/* RWD: æ‰‹æ©Ÿç›´å¼æ™‚ï¼Œæ¨™é¡Œéé•·è‡ªå‹•æ›è¡Œ */
        .mobile-break { display: none; }
        
        @media (max-width: 600px) {
            .mobile-break { display: block; height: 0; }
            .header-container h1 { font-size: 1rem; }
            .header-btn { padding: 5px 10px; font-size: 0.85rem; }
            .header-btn span { display: none; } /* æ‰‹æ©Ÿç‰ˆå¤ªçª„æ™‚ï¼Œéš±è—æ‰‹æŒ‡åœ–ç¤º */
        }

    </style>
</head>
<body>

	<div class="header-container">
        <h1>
            <img src="logo.jpg" alt="Logo" class="title-logo" onerror="this.style.display='none'">
            <div>
                æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€<span class="mobile-break"></span>æœˆç›¸ç›ˆè™§
            </div>
        </h1>

        <div class="nav-buttons">
            <a href="https://line.me/ti/g2/TTCqPpZP6lQqX1z_AUDPNm4977Dvylew3O7oBg" target="_blank" class="header-btn" title="åŠ å…¥å®˜æ–¹LINE">
                <span>ğŸ‘‰</span>åŠ  LINE æå•
            </a>
            
            </div>
    </div>

    <div id="simWrapper">
        <div class="simulation-container" id="simContainer">
            
            <div class="sun-indicator-group">
                <div class="sun-arrows-col">
                    <div class="arrow-icon">â—€</div>
                    <div class="arrow-icon">â—€</div>
                    <div class="arrow-icon">â—€</div>
                </div>
                <div class="sun-text-col">å¤ªé™½å…‰</div>
            </div>

            <div class="system-center">
                
                <div class="earth-group">
                    <div class="earth-visual">
                        <div class="earth-shadow-overlay"></div>
                    </div>
                    
                    <div class="observer-container" id="observerContainer">
                        <div class="stickman">
                            <div class="stickman-head"></div>
                            <div class="stickman-body"></div>
                        </div>
                    </div>
                </div>

                <div class="time-marker" style="top: 50%; right: 25px; transform: translateY(-50%);">12:00</div>
                <div class="time-marker" style="top: 25px; left: 50%; transform: translateX(-50%);">18:00</div>
                <div class="time-marker" style="top: 50%; left: 25px; transform: translateY(-50%);">24:00</div>
                <div class="time-marker" style="bottom: 25px; left: 50%; transform: translateX(-50%);">06:00</div>

                <div class="moon-visual" id="moonVisual">
                    <div class="moon-shadow-part" id="moonShadowFix"></div>
                </div>
                <div class="moon-label" id="moonLabel"></div>
                
            </div>

            <div class="view-from-earth" id="viewFromEarthPanel">
                <div class="view-title">æœˆç›¸ç›ˆè™§ (é¢å‘å—æ–¹)</div>
                <div class="moon-phase-render">
                    <svg class="phase-svg" viewBox="0 0 100 100">
                        <path id="phasePath" class="phase-path" d="" />
                    </svg>
                </div>
                <div class="direction-labels">
                    <span class="dir-tag">æ±</span>
                    <span class="dir-tag">è¥¿</span>
                </div>
            </div>

            <div class="view-horizon" id="viewHorizonPanel">
                <div class="view-title">ç•¶æ—¥è»Œè·¡ (é¢å‘å—æ–¹)</div>
                <div class="horizon-stage">
                    <div class="horizon-moon" id="horizonMoon">
                        <svg class="phase-svg" viewBox="0 0 100 100">
                            <path id="horizonPhasePath" class="phase-path" d="" />
                        </svg>
                    </div>
                </div>
                <div class="direction-labels">
                    <span class="dir-tag">æ±å‡</span>
                    <span class="dir-tag">è¥¿è½</span>
                </div>
            </div>

        </div>
    </div>

    <div class="info-card">
        <div class="info-header">
            <span class="date-display" id="dateDisplay">è¾²æ›† åˆä¸€</span>
            <div class="phase-name-group" id="phaseGroup">
                <span class="phase-name" id="phaseName">æ–°æœˆ (æœ”)</span>
            </div>
        </div>
        
        <div class="info-grid">
            <div class="info-item">
                <span class="label">ğŸŒ… æœˆå‡ºæ™‚åˆ»ï¼š</span>
                <span class="highlight" id="moonRiseTime">06:00</span>
            </div>
            <div class="info-item">
                <span class="label">ğŸŒ„ æœˆè½æ™‚åˆ»ï¼š</span>
                <span class="highlight" id="moonSetTime">18:00</span>
            </div>
            <div class="info-item">
                <span class="label">ğŸŒ“ æ˜æš—ç‹€æ³ï¼š</span>
                <span class="blue-high" id="brightnessInfo">å…¨æš—</span>
            </div>
            <div class="info-item">
                <span class="label">ğŸŒŸ ç‰¹æ®Šç¾è±¡ï¼š</span>
                <span id="phenomenonDisplay">ç„¡</span>
            </div>
        </div>
        
        <div class="desc-wrapper">
            <span class="label">ğŸ’¡ èªªã€€ã€€æ˜ï¼š</span>
            <span id="descText">æœˆçƒä½æ–¼åœ°çƒèˆ‡å¤ªé™½ä¸­é–“ï¼ŒèƒŒå…‰é¢å‘åœ°çƒã€‚</span>
        </div>
    </div>

    <div class="controls">
        <div class="btn-group">
            <button class="btn" onclick="stopAllAnim(); setLunarDay(1)">åˆä¸€</button>
            <button class="btn" onclick="stopAllAnim(); setLunarDay(8.4)">åˆä¸ƒæˆ–åˆå…«</button>
            <button class="btn" onclick="stopAllAnim(); setLunarDay(15.8)">åäº”æˆ–åå…­</button>
            <button class="btn" onclick="stopAllAnim(); setLunarDay(23.1)">å»¿äºŒæˆ–å»¿ä¸‰</button>
            
            <select id="festivalSelect" class="festival-select" onchange="applyFestival(this.value)">
                <option value="" disabled selected hidden>ç¯€æ—¥</option>
                <option value="1">æ˜¥ç¯€</option>
                <option value="15">å…ƒå®µ</option>
                <option value="5">ç«¯åˆ</option>
                <option value="7">ä¸ƒå¤•</option> 
                <option value="15">ä¸­å…ƒ</option>
                <option value="15">ä¸­ç§‹</option>
                <option value="9">é‡é™½</option>
                <option value="30">é™¤å¤•</option>
            </select>
        </div>
        
        <div class="control-row">
            <label>è¾²æ›†æ—¥æœŸ</label>
            <input type="range" id="daySlider" min="1" max="30" value="1" step="1" 
                   oninput="updateSim('manual')">
            <span id="dayVal" style="font-weight:bold; width: 40px; text-align:right;">1</span>
            <button class="btn-auto" id="btnAutoDay" onclick="toggleDayAnim()" title="è‡ªå‹•æ’­æ”¾æ—¥æœŸ">â–¶</button>
        </div>

        <div class="time-btn-group" style="margin-bottom:8px;">
             <button class="time-btn" onclick="setTime(6)">06:00</button>
            <button class="time-btn" onclick="setTime(12)">12:00</button>
            <button class="time-btn" onclick="setTime(18)">18:00</button>
            <button class="time-btn" onclick="setTime(24)">24:00</button>
        </div>

        <div class="control-row">
            <label>è§€æ¸¬æ™‚é–“</label>
            <input type="range" id="timeSlider" min="0" max="24" value="12" step="0.05" 
                   oninput="updateSim('manual')">
            <span id="timeVal" style="font-weight:bold; width: 40px; text-align:right;">12:00</span>
            <button class="btn-auto" id="btnAutoTime" onclick="toggleTimeAnim()" title="è‡ªå‹•æ’­æ”¾æ™‚é–“">â–¶</button>
        </div>
    </div>

    <script>
        function resizeSimulation() {
            const wrapper = document.getElementById('simWrapper');
            const simContainer = document.getElementById('simContainer');
            const availableWidth = Math.min(window.innerWidth, document.body.clientWidth) - 20; 

            if (availableWidth < 600) {
                const scale = availableWidth / 600;
                simContainer.style.transform = `scale(${scale})`;
                wrapper.style.width = `${600 * scale}px`;
                wrapper.style.height = `${420 * scale}px`;
            } else {
                simContainer.style.transform = 'none';
                wrapper.style.width = '600px';
                wrapper.style.height = '420px';
            }
        }
        window.addEventListener('resize', resizeSimulation);

        function setLunarDay(day) {
            document.getElementById('daySlider').value = day;
            updateSim('manual');
        }

        function setTime(hour) {
            document.getElementById('timeSlider').value = hour;
            updateSim('manual');
        }

        function applyFestival(val) {
            if(!val) return;
            stopAllAnim();
            setLunarDay(parseFloat(val));
        }

        // --- Animation Logic ---
        let dayAnim = null;
        let timeAnim = null;

        document.addEventListener('pointerdown', (e) => {
            if (!e.target.closest('.btn-auto')) {
                stopAllAnim();
            }
        });

        function stopAllAnim() {
            let stopped = false;
            if (dayAnim) {
                clearInterval(dayAnim);
                dayAnim = null;
                const dBtn = document.getElementById('btnAutoDay');
                dBtn.innerText = "â–¶";
                dBtn.classList.remove('active');
                stopped = true;
            }
            if (timeAnim) {
                clearInterval(timeAnim);
                timeAnim = null;
                const tBtn = document.getElementById('btnAutoTime');
                tBtn.innerText = "â–¶";
                tBtn.classList.remove('active');
                stopped = true;
            }
            if (stopped) {
                updateSim('manual');
            }
        }

        function toggleDayAnim() {
            const btn = document.getElementById('btnAutoDay');
            const wasActive = btn.classList.contains('active');
            
            stopAllAnim(); 

            if (!wasActive) {
                btn.innerText = "â– ";
                btn.classList.add('active');
                
                let currentVal = parseFloat(document.getElementById('daySlider').value);

                dayAnim = setInterval(() => {
                    // V22 Update: 12 seconds per cycle
                    currentVal += 0.1;
                    if (currentVal > 30.5) currentVal = 1;
                    updateSim('autoDay', currentVal);
                }, 40);
            }
        }

        function toggleTimeAnim() {
            const btn = document.getElementById('btnAutoTime');
            const wasActive = btn.classList.contains('active');
            
            stopAllAnim();

            if (!wasActive) {
                btn.innerText = "â– ";
                btn.classList.add('active');
                
                let currentVal = parseFloat(document.getElementById('timeSlider').value);

                timeAnim = setInterval(() => {
                    // V22 Update: 12 seconds per cycle
                    currentVal += 0.06;
                    if (currentVal >= 24) currentVal = 0;
                    
                    updateSim('autoTime', currentVal);
                }, 30);
            }
        }

        function updateSim(mode = 'manual', overrideVal = null) {
            let lunarDay = parseFloat(document.getElementById('daySlider').value);
            let timeHour = parseFloat(document.getElementById('timeSlider').value);

            if (mode === 'autoDay' && overrideVal !== null) {
                lunarDay = overrideVal;
                const sliderShow = (lunarDay > 30) ? 30 : lunarDay;
                document.getElementById('daySlider').value = sliderShow;
            }
            if (mode === 'autoTime' && overrideVal !== null) {
                timeHour = overrideVal;
                document.getElementById('timeSlider').value = timeHour;
            }
            
            document.getElementById('dayVal').innerText = Math.floor(lunarDay);
            document.getElementById('timeVal').innerText = formatTime(timeHour);

            // 1. æœˆçƒå…¬è½‰
            const moonAngle = ((lunarDay - 1) / 29.5) * 360; 
            const rad = moonAngle * (Math.PI / 180);
            const radius = 150; 
            const x = Math.cos(rad) * radius;
            const y = Math.sin(rad) * radius * -1; 

            const moonVisual = document.getElementById('moonVisual');
            const moonLabel = document.getElementById('moonLabel');
            moonVisual.style.transform = `translate(${x}px, ${y}px)`;
            moonLabel.style.transform = `translate(${x}px, ${y - 25}px) translateX(-50%)`;

            // 2. è§€æ¸¬è€…å…¬è½‰
            const obsRot = (timeHour - 12) * 15;
            const finalStickRot = 90 - obsRot; 
            document.getElementById('observerContainer').style.transform = `translate(-50%, -50%) rotate(${finalStickRot}deg)`;

            // 3. å³ä¸‹è§’è¦–çª—
            if (mode !== 'autoDay') {
                const earthRotationAngle = (timeHour - 12) * 15;
                updateHorizonView(moonAngle, earthRotationAngle, lunarDay);
            }

            // 4. è³‡è¨Šèˆ‡æœˆç›¸
            updateInfoPanel(lunarDay, moonAngle, timeHour);
            
            if (mode !== 'autoTime') {
                drawMoonPhase(lunarDay); 
            }
            
            // æŒ‰éˆ•ç‹€æ…‹é¡¯ç¤º
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            if(mode === 'manual') { 
                let dInt = Math.floor(lunarDay);
                
                if(Math.abs(lunarDay - 1) < 2) 
                    document.querySelectorAll('.btn')[0].classList.add('active');
                else if(dInt === 7 || dInt === 8) 
                    document.querySelectorAll('.btn')[1].classList.add('active');
                else if(dInt === 15 || dInt === 16) 
                    document.querySelectorAll('.btn')[2].classList.add('active');
                else if(dInt === 22 || dInt === 23) 
                    document.querySelectorAll('.btn')[3].classList.add('active');
            }
        }

        function updateHorizonView(moonOrbitAngle, observerAngle, day) {
            let delta = moonOrbitAngle - observerAngle;
            while(delta <= -180) delta += 360;
            while(delta > 180) delta -= 360;

            const moonElem = document.getElementById('horizonMoon');
            
            if (delta > -100 && delta < 100) {
                moonElem.style.display = 'block';
                const rad = delta * (Math.PI / 180);
                
                // xPos: +Delta is East (Left), -Delta is West (Right)
                // Sin(90)=1 -> 50-42=8 (Left). Sin(-90)=-1 -> 50+42=92 (Right). Correct.
                const xPos = 50 - (Math.sin(rad) * 42); 
                const yPos = 100 - (Math.cos(rad) * 75); 
                
                moonElem.style.left = `${xPos}%`;
                moonElem.style.top = `${yPos}%`;
                
                // --- V26.1 Fix: Correct Field Rotation (å ´æ—‹è½‰ä¿®æ­£) ---
                // ä½¿ç”¨ -delta é€²è¡Œåå‘è£œå„Ÿï¼Œä»¥ç¬¦åˆåœ°å¹³åº§æ¨™çš„è¦–è¦ºæŠ•å½±
                // ä¸Šå¼¦æœˆ(å³äº®)æ±å‡: Delta +90 -> Rotate -90 -> äº®é¢æœä¸Š(å°èˆ¹)
                // ä¸Šå¼¦æœˆ(å³äº®)è¥¿è½: Delta -90 -> Rotate +90 -> äº®é¢æœä¸‹(æ‹±é–€)
                moonElem.style.transform = `translate(-50%, -50%) rotate(${-delta}deg)`;

            } else {
                moonElem.style.display = 'none';
            }

            drawMoonPhasePath(day, 'horizonPhasePath');
        }

        function updateInfoPanel(day, angle, currentHour) {
            let phase = "";
            let tide = "";
            let eclipse = "";
            let showTitle = false;

            let rise = 6;
            let set = 18;
            let brightDesc = "";
            let desc = "";

            let dayInt = Math.floor(day);

            // æ˜æš—ç‹€æ³
            if (dayInt >= 29 || dayInt <= 1) {
                brightDesc = "å…¨æš—";
            } 
            else if (dayInt >= 15 && dayInt <= 16) {
                brightDesc = "å…¨äº®";
            } 
            else if (dayInt >= 2 && dayInt <= 14) {
                brightDesc = "è¥¿äº®æ±æš—";
            } 
            else {
                brightDesc = "è¥¿æš—æ±äº®";
            }

            // æœˆç›¸åç¨±èˆ‡æè¿°
            if (day >= 29.5) {
                phase = "æ™¦æœˆ"; tide = "å¤§æ½®"; showTitle = true; rise = 6; set = 18;
                desc = "æœˆçƒé€±æœŸçš„æœ€å¾Œä¸€å¤©ï¼Œçœ‹ä¸è¦‹æœˆäº®ã€‚";
            } 
            else if (dayInt <= 1) { 
                phase = "æ–°æœˆ (æœ”)"; tide = "å¤§æ½®"; 
                if (Math.abs(day - 1) < 1.5) eclipse = "å¯èƒ½æ—¥é£Ÿ";
                showTitle = true; rise = 6; set = 18;
                desc = "æœˆçƒä½æ–¼åœ°çƒèˆ‡å¤ªé™½ä¸­é–“ï¼ŒèƒŒå…‰é¢å‘åœ°çƒã€‚ ç­åˆ¥ï¼šæ—©ç­æœˆäº®";
            } 
            else if (dayInt === 7 || dayInt === 8) { 
                phase = "ä¸Šå¼¦æœˆ"; tide = "å°æ½®"; showTitle = true; rise = 12; set = 24;
                desc = "ä¸­åˆå‡èµ·ï¼Œåˆå¤œè½ä¸‹ã€‚ ç­åˆ¥ï¼šåˆç­æœˆäº®";
            } 
            else if (dayInt === 15 || dayInt === 16) { 
                phase = "æ»¿æœˆ (æœ›)"; tide = "å¤§æ½®";
                if (Math.abs(day - 15) < 1.5) eclipse = "å¯èƒ½æœˆé£Ÿ";
                showTitle = true; rise = 18; set = 6;
                desc = "å¤ªé™½è¥¿è½ï¼Œæœˆçƒæ±æ˜‡ï¼Œæ•´å¤œå¯è¦‹ã€‚ ç­åˆ¥ï¼šæ™šç­æœˆäº®";
            } 
            else if (dayInt === 22 || dayInt === 23) { 
                phase = "ä¸‹å¼¦æœˆ"; tide = "å°æ½®"; showTitle = true; rise = 0; set = 12;
                desc = "åˆå¤œå‡èµ·ï¼Œä¸­åˆè½ä¸‹ã€‚ ç­åˆ¥ï¼šå¤§å¤œç­æœˆäº®";
            } 
            else {
                showTitle = false; 
                if (day < 7) {
                    phase = "çœ‰æœˆ"; tide = "ä¸­æ½®"; rise = 9; set = 21; desc = "å‚æ™šè¦‹æ–¼è¥¿æ–¹ä½ç©ºã€‚";
                } else if (day < 15) {
                    phase = "ç›ˆå‡¸æœˆ"; tide = "ä¸­æ½®"; rise = 15; set = 3; desc = "åˆå¾Œå‡èµ·ï¼Œå‡Œæ™¨è½ä¸‹ã€‚";
                } else if (day < 22) {
                    phase = "è™§å‡¸æœˆ"; tide = "ä¸­æ½®"; rise = 21; set = 9; desc = "å…¥å¤œå‡èµ·ï¼Œæ¸…æ™¨è¥¿æ–¹å¯è¦‹ã€‚";
                } else {
                    phase = "æ®˜æœˆ"; tide = "ä¸­æ½®"; rise = 3; set = 15; desc = "æ¸…æ™¨æ±æ–¹ä½ç©ºå¯è¦‹ã€‚";
                }
            }

            // æ¸²æŸ“
            let dayStr = "";
            const daysMap = ["", "åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", 
                             "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå",
                             "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
            if (dayInt <= 30) dayStr = daysMap[dayInt] || "";
            document.getElementById('dateDisplay').innerText = `è¾²æ›† ${dayStr}`;

            const phaseNameEl = document.getElementById('phaseName');
            if (showTitle) {
                phaseNameEl.innerText = phase;
                phaseNameEl.style.display = 'inline';
            } else {
                phaseNameEl.innerText = "";
                phaseNameEl.style.display = 'none';
            }

            const phenomEl = document.getElementById('phenomenonDisplay');
            if (showTitle) {
                 let content = "";
                 content += `<span class="tide-badge" style="background:${(tide=='å¤§æ½®'?'#c0392b':(tide=='å°æ½®'?'#27ae60':'#7f8c8d'))}">${tide}</span>`;
                 if(eclipse) {
                    content += ` <span class="phenomenon-badge">${eclipse}</span>`;
                 }
                 phenomEl.innerHTML = content;
            } else {
                 phenomEl.innerText = "ç„¡";
            }

            const buttonDates = [1, 7, 8, 15, 16, 22, 23];
            const showTimes = buttonDates.includes(dayInt);

            if(showTimes) {
                document.getElementById('moonRiseTime').innerText = formatTime(rise);
                document.getElementById('moonSetTime').innerText = formatTime(set);
            } else {
                document.getElementById('moonRiseTime').innerText = "";
                document.getElementById('moonSetTime').innerText = "";
            }

            document.getElementById('brightnessInfo').innerText = brightDesc;
            document.getElementById('descText').innerText = desc;
        }

        function formatTime(h) {
            h = h % 24;
            let hh = Math.floor(h);
            let mm = Math.floor((h - hh) * 60);
            return `${hh < 10 ? '0'+hh : hh}:${mm < 10 ? '0'+mm : mm}`;
        }

        function drawMoonPhase(day) {
            drawMoonPhasePath(day, 'phasePath');
        }

        function drawMoonPhasePath(day, targetId) {
            let cycle = (day - 1) / 29.5;
            if(cycle < 0) cycle = 0;
            if(cycle > 1) cycle = cycle % 1;

            const path = document.getElementById(targetId);
            let d = "";
            
            if (cycle <= 0.5) {
                if (cycle < 0.25) {
                    d = `M 50 0 A 50 50 0 0 1 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI)} 50 0 0 0 50 0`;
                } else {
                    d = `M 50 0 A 50 50 0 0 1 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI) * -1} 50 0 0 1 50 0`;
                }
            } else {
                if (cycle <= 0.75) {
                    d = `M 50 0 A 50 50 0 0 0 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI) * -1} 50 0 0 0 50 0`;
                } else {
                    d = `M 50 0 A 50 50 0 0 0 50 100 A ${50 * Math.cos(cycle * 2 * Math.PI)} 50 0 0 1 50 0`;
                }
            }
            if (Math.abs(day - 15) < 0.5) d = "M 50 0 A 50 50 0 1 1 50 100 A 50 50 0 1 1 50 0";
            if (day < 1 || day > 29.5) d = "";

            path.setAttribute('d', d);
        }

        window.onload = function() {
            resizeSimulation();
            updateSim('manual');
        };

    </script>
</body>
</html>