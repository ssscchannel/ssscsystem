<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€ç‰©è³ªä¸‰æ…‹æ¨¡æ“¬</title>
    
    <style>
        /* =========================================
           1. æ ¸å¿ƒæ¶æ§‹ï¼šApp Shell (ä¿ç•™åŸæ¨£)
           ========================================= */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100dvh; 
            overflow: hidden;
            
            display: flex;
            flex-direction: column;
            align-items: center;
            
            background-image: url('page.jpg'); 
            background-size: cover;
            background-position: center;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            color: #333;
            user-select: none;
            -webkit-user-select: none;
        }

        .app-layout-wrapper {
            width: 100%;
            max-width: 600px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
        }

        .app-layout-wrapper::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            z-index: -1;
        }

        /* =========================================
           2. é ‚éƒ¨ï¼šæ¨™é¡Œåˆ—
           ========================================= */
        .main-header {
            flex: 0 0 60px;
            width: 100%;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f, #fdbb2d);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-sizing: border-box;
            color: white;
        }

        .logo-area {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            margin-right: 15px;
            background-image: url('logo.jpg');
            background-size: cover;
            border: 2px solid #00d2ff;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.0rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            color: white;
            white-space: normal;
            line-height: 1.2;          
            max-height: 2.4em;         
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex: 1;                   
            padding-right: 10px;       
        }

        .line-btn {
            margin-left: auto;
            background-color: #00B900;
            color: white;
            text-decoration: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        
        .line-btn:active {
            transform: scale(0.95);
            background-color: #009900;
        }

        /* =========================================
           3. ä¸­é–“ï¼šå…§å®¹å€
           ========================================= */
        .content-scroll-area {
            flex: 1 1 auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            padding: 0;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .ui-card {
            width: 96% !important;
            max-width: 96% !important;
            box-sizing: border-box;
            margin-left: auto;
            margin-right: auto;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 12px;
        }

        .topic-description {
            text-align: center;
            color: #444;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* =========================================
           4. æ¨¡æ“¬å™¨ç‰¹å®šæ¨£å¼
           ========================================= */
        .simulation-container {
            width: 96%;
            aspect-ratio: 1 / 1;
            background: #f0f4f8;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            touch-action: none;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .thermometer-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 12px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: bold;
            border: 1px solid #ccc;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 5;
        }

        /* =========================================
           5. åº•éƒ¨æ§åˆ¶å¡¢
           ========================================= */
        .controls-dock {
            flex: 0 0 auto;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            padding: 15px;
            box-sizing: border-box;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .state-btn-group {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: space-between;
        }

        .state-btn {
            flex: 1;
            padding: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: default;
            transition: all 0.2s;
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 6px;
            background: #f5f5f5;
            color: #666;
            border: 2px solid transparent;
        }
        
        .state-btn span { font-size: 1.2rem; }

        .state-btn.active { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .state-btn[data-state="solid"].active { background: #e3f2fd; color: #1565c0; border-color: #1565c0; }
        .state-btn[data-state="liquid"].active { background: #e0f7fa; color: #006064; border-color: #006064; }
        .state-btn[data-state="gas"].active { background: #fff3e0; color: #e65100; border-color: #e65100; }

        .lever-wrapper {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(90deg, #3498db 0%, #ffffff 50%, #e74c3c 100%);
            padding: 10px 15px;
            border-radius: 30px;
            border: 1px solid #ddd;
            position: relative;
            box-sizing: border-box;
        }
        
        .lever-label { 
            font-size: 1.2rem; 
            font-weight: bold;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            width: 24px;
            text-align: center;
        }

        input[type=range] {
            flex: 1;
            -webkit-appearance: none;
            background: transparent;
            z-index: 2;
            margin: 0;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            margin-top: -12px;
            border: 3px solid #555;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }

        .hint-text {
            text-align: center;
            font-size: 0.8rem;
            color: #888;
            margin-top: -5px;
        }

    </style>
</head>
<body>

    <div class="app-layout-wrapper">
        
        <header class="main-header">
            <a href="index.html" class="logo-area" title="è¿”å›å¤§å»³"></a>
            <div class="header-title">æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±<br>æ°´çš„ä¸‰æ…‹è®ŠåŒ–</div>
            <a href="https://line.me/ti/g2/TTCqPpZP6lQqX1z_AUDPNm4977Dvylew3O7oBg" target="_blank" class="line-btn">
                åŠ  LINE è¨è«–
            </a>
        </header>

        <main class="content-scroll-area">
            
            <div class="ui-card topic-description">
                è§€å¯Ÿæ°´åˆ†å­åœ¨ä¸åŒæº«åº¦ä¸‹çš„æ’åˆ—èˆ‡é‹å‹•ç‹€æ…‹ã€‚<br>
                è©¦è‘—æ”¹è®Šæº«åº¦ï¼Œçœ‹çœ‹å›ºæ…‹ã€æ¶²æ…‹èˆ‡æ°£æ…‹æœ‰ä»€éº¼ä¸åŒã€‚
            </div>

            <div class="simulation-container" id="sim-container">
                <canvas id="simCanvas"></canvas>
                <div class="thermometer-display">
                    <span>ğŸŒ¡ï¸</span>
                    <span id="tempValue">25</span>Â°C
                </div>
            </div>

        </main>

        <footer class="controls-dock">
            
            <div class="state-btn-group">
                <button class="state-btn" data-state="solid" >
                    <span>ğŸ§Š</span>å›ºæ…‹
                </button>
                <button class="state-btn active" data-state="liquid" >
                    <span>ğŸ’§</span>æ¶²æ…‹
                </button>
                <button class="state-btn" data-state="gas" >
                    <span>â˜ï¸</span>æ°£æ…‹
                </button>
            </div>

            <div class="lever-wrapper">
                <span class="lever-label">â„ï¸</span>
                <input type="range" id="heatLever" min="-273" max="300" value="0" step="1">
                <span class="lever-label">ğŸ”¥</span>
            </div>
            <div class="hint-text">
                å·¦å³æ’¥å‹•ä»¥èª¿æ•´æº«åº¦
            </div>

        </footer>
    </div>

    <script>
    // =========================================
    // æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ï¼šç‰©ç†ç›´è¦ºæœ€çµ‚ç‰ˆ (å·¥ç¨‹å„ªåŒ–ç‰ˆ)
    // =========================================
    
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    // ç‰©ç†å¸¸æ•¸
    const NUM_PARTICLES = 120; 
    const PARTICLE_RADIUS = 12; 
    const PADDING = 20; 
    const CONTAINER_WIDTH = 1000; 
    const CONTAINER_HEIGHT = 1000; 
    
    // ç³»çµ±è®Šæ•¸
    let temperature = 25; 
    let heatPower = 0;    
    let currentPhase = 'liquid'; 
    let scale = 1; 
    let particles = [];

    // ç²’å­é¡åˆ¥
    class Particle {
        constructor(id) {
            this.id = id;
            this.reset();
            
            // å›ºæ…‹å°ˆç”¨
            this.latticeX = 0;
            this.latticeY = 0;
            this.anchored = false; 
            
            // ç‹€æ…‹
            this.isGas = false;
            
            // è¦–è¦º
            this.baseAngle = Math.random() * Math.PI * 2;
        }

        reset() {
            this.x = PADDING + Math.random() * (CONTAINER_WIDTH - PADDING*2);
            this.y = Math.random() * CONTAINER_HEIGHT;
            this.vx = (Math.random() - 0.5) * 5;
            this.vy = (Math.random() - 0.5) * 5;
            this.angle = Math.random() * Math.PI * 2;
            this.vAngle = (Math.random() - 0.5) * 0.1;
            this.radius = PARTICLE_RADIUS;
        }

        // ============================================
        // æ ¸å¿ƒç‰©ç†æ›´æ–° (å·¥ç¨‹å„ªåŒ–ï¼šè‡ªé©æ‡‰é˜»å°¼)
        // ============================================
        update(dt = 1.0) {
            
            // ----------------------------------------
            // A. å›ºæ…‹æ¨¡å¼
            // ----------------------------------------
            if (temperature <= 0) {
                this.isGas = false; 

                if (!this.anchored) {
                    // è‡ªç”±è½é«”éšæ®µï¼šä½é˜»åŠ›ï¼Œè®“å®ƒå¿«é€Ÿæ‰ä¸‹ä¾†
                    this.vy += 0.4 * dt; 
                    this.vx *= 0.85; 
					this.vy *= 0.85;
                    this.x += this.vx * dt;
                    this.y += this.vy * dt;

                    if (this.y > CONTAINER_HEIGHT - PADDING - this.radius) {
                        this.anchored = true;
                        this.latticeX = this.x;
                        this.latticeY = this.y;
                    }
                } else {
                    // æ™¶æ ¼é–å®šéšæ®µï¼šé«˜ç©©å®šæ€§
                    const k = 0.05; 
                    const friction = 0.8; 
                    
                    const forceX = (this.latticeX - this.x) * k;
                    const forceY = (this.latticeY - this.y) * k;
                    this.vx += forceX; this.vy += forceY;
                    this.vx *= friction; this.vy *= friction;
                    
                    // å¡‘æ€§è®Šå½¢
                    this.latticeX += (this.x - this.latticeX) * 0.02; 
                    this.latticeY += (this.y - this.latticeY) * 0.02;

                    // ç†±éœ‡å‹•
                    let tempRatio = Math.max(0, (temperature + 273) / 273);
                    this.vx += (Math.random() - 0.5) * 0.5 * tempRatio;
                    this.vy += (Math.random() - 0.5) * 0.5 * tempRatio;

                    this.x += this.vx; 
                    this.y += this.vy;
                }

                // å¼·åˆ¶é‚Šç•Œ
                if (this.x < PADDING) { this.x = PADDING; this.vx = 0; }
                if (this.x > CONTAINER_WIDTH - PADDING) { this.x = CONTAINER_WIDTH - PADDING; this.vx = 0; }
                if (this.y > CONTAINER_HEIGHT - PADDING) { this.y = CONTAINER_HEIGHT - PADDING; this.vy = 0; }
                
                let tempRatio = Math.max(0, (temperature + 273) / 273);
                this.angle = this.baseAngle + (Math.random() - 0.5) * 0.2 * tempRatio;
                return;
            }

            // ----------------------------------------
            // B. æµé«”æ¨¡å¼ (æ¶²é«” + æ°£é«”)
            // ----------------------------------------
            this.anchored = false; 

            // 1. ç›¸è®Šåˆ¤å®š
            if (!this.isGas) {
				// 1. è¨ˆç®—æº«åº¦æ¯”ä¾‹ (0åº¦=0.0, 50åº¦=0.5, 100åº¦=1.0)
				let tRatio = Math.max(0, temperature) / 100; 

				// 2. æ©Ÿç‡æ›²ç·šï¼šä½¿ç”¨ã€Œä¸‰æ¬¡æ–¹ã€è®“ä½æº«è·Ÿé«˜æº«æ‹‰é–‹å·¨å¤§å·®è·
				// 25åº¦æ™‚: 0.25^3 = 0.015 (æ¥µå°)
				// 85åº¦æ™‚: 0.85^3 = 0.614 (è®Šå¤§ 40 å€!)
				let evapChance = 0.003 * Math.pow(tRatio, 4);

				// æ²¸é¨°æ™‚æ©Ÿç‡ç›´æ¥æ‹‰æ»¿
				if (temperature >= 100) evapChance = 0.1;

				if (Math.random() < evapChance * dt) {
					this.isGas = true;

					// 3. å‡ºé€ŸåŠ›é“ï¼šæº«åº¦è¶Šé«˜ï¼Œè¡å‡ºå»è¶Šå¿«					
					let kickPower = 4.0 + 8.0 * tRatio; 
        
					// å‘ä¸Šè¡åˆº (è² å€¼ç‚ºå‘ä¸Š)
					this.vy -= (kickPower + Math.random() * 5.0); 
        
					// æ©«å‘æ“´æ•£ (æº«åº¦é«˜æ™‚æ“´æ•£ä¹Ÿè®Šå¤§)
					let spread = 2.0 + 6.0 * tRatio;
					this.vx += (Math.random() - 0.5) * spread;
				}
			} else {
                // å‡çµåˆ¤å®š
                let condenseChance = 0;
                // åªæœ‰æ¥è§¸æ¶²é¢ä¸”å‘ä¸‹é‹å‹•æ‰å®¹æ˜“å‡çµ
                if (this.y > CONTAINER_HEIGHT - PARTICLE_RADIUS * 8 && this.vy > 0) {
                     condenseChance = 0.2; 
                }
                if (temperature < 50) condenseChance += 0.001;

                if (Math.random() < condenseChance * dt) {
                    this.isGas = false;
                    this.vx *= 0.5; 
                    this.vy *= 0.5;
                }
            }

            // 2. é‹å‹•ç‰©ç† (Adaptive Physics Core)
            const speedSq = this.vx*this.vx + this.vy*this.vy;
            
            if (this.isGas) {
                // [æ°£é«”ç‰©ç†]
                this.vy -= 0.005 * dt; // å¾®é‡åŠ›
                this.vx *= 1;     // æ¥µä½é˜»åŠ› (è‡ªç”±é£›è¡Œ)
                this.vy *= 1;

            } else {
                // [æ¶²é«”ç‰©ç†] - è‡ªé©æ‡‰é˜»å°¼
                this.vy += 0.4 * dt; // æ­£å¸¸é‡åŠ› (ä¸å†æ‰“æŠ˜)

                if (speedSq > 2.0) {
                    // é«˜é€Ÿç‹€æ…‹ (è‡ªç”±è½é«”ã€æµå‹•)ï¼šä½é˜»åŠ›
                    this.vx *= 0.99; 
                    this.vy *= 0.99; 
                } else {
                    // ä½é€Ÿç‹€æ…‹ (å †ç–Šã€å¹³éœæ°´é¢)ï¼šé«˜é˜»å°¼ (The Swamp)
                    // é€™èƒ½æœ‰æ•ˆæŠ‘åˆ¶æŠ–å‹•ï¼Œä½†ä¸æœƒå½±éŸ¿æ‰è½ä¸­çš„æ°´
                    this.vx *= 0.96; 
                    this.vy *= 0.96; 
                }

                // æº«åº¦å¾®æ“¾å‹• (æ¨¡æ“¬å¸ƒæœ—é‹å‹•ï¼Œä½†åªå°ä½é€Ÿç²’å­é¡¯è‘—)
                let activity = Math.max(0, temperature) / 300;
				if (temperature > 80) activity *= 2.0;
                this.vx += (Math.random() - 0.5) * activity;
				this.vy += (Math.random() - 0.5) * activity;
            }
            
            // 3. ä½ç½®æ›´æ–°
            // æ°£é«”å—æº«åº¦åŠ é€Ÿï¼Œæ¶²é«”ä¿æŒ 1.0 çœŸå¯¦é€Ÿåº¦
            let speedScale = this.isGas ? (1.0 + Math.max(0, temperature-25)/200) : 1.0;
            					
            this.x += this.vx * speedScale * dt;
            this.y += this.vy * speedScale * dt;

            this.handleBoundaries(this.isGas ? 0.95 : 0.4);
            
            // è§’åº¦æ›´æ–°
            this.angle += this.vAngle * (this.isGas ? 2 : 1) * dt;
        }

        handleBoundaries(bounce) {
            
			let wallBounce = this.isGas ? 1.0 : 0.4;
			
			if (this.x < PADDING) { this.x = PADDING; this.vx *= -1 * wallBounce; }
			if (this.x > CONTAINER_WIDTH - PADDING) { this.x = CONTAINER_WIDTH - PADDING; this.vx *= -1 * wallBounce; }
			if (this.y > CONTAINER_HEIGHT - PADDING) { this.y = CONTAINER_HEIGHT - PADDING; this.vy *= -1 * wallBounce; }
            // 4. [é—œéµä¿®æ”¹] æ’åˆ°å¤©èŠ±æ¿ -> å¼·åˆ¶å‡çµ
			if (this.y < PADDING) { 
				this.y = PADDING; 
    
				// åªæœ‰åœ¨ã€Œæº«åº¦ä¸å¤ é«˜ã€çš„æ™‚å€™ï¼Œæ’åˆ°å¤©èŠ±æ¿æ‰æœƒå‡çµ
				// å¦‚æœå·²ç¶“æ²¸é¨° (>=100)ï¼Œå¤©èŠ±æ¿å°±ä¸å†å…·å‚™å†·å‡èƒ½åŠ›ï¼Œæ°£é«”æ‡‰è©²åå½ˆ
				let isBoiling = temperature >= 100;

				if (this.isGas && !isBoiling) {
					// [ä½æº«æ¨¡å¼]ï¼šå†·å‡æ•ˆæ‡‰
					this.isGas = false; 
					this.vy *= -1 * 0.5; // åå½ˆä¸¦æå¤±èƒ½é‡
					this.vy += 2.0;      // åŠ ä¸Šé‡åŠ›æ»´è½æ„Ÿ
				} else {
					// [æ²¸é¨°æ¨¡å¼] æˆ– [éæ°£é«”]ï¼šå–®ç´”åå½ˆ
					// æ°£é«”ä¿æŒæ°£æ…‹ï¼Œç¹¼çºŒåœ¨å®¹å™¨å…§äº‚æ’
					this.vy *= -1 * wallBounce; 
				}
			}
        }

        draw(ctx) {
            if (isNaN(this.x) || isNaN(this.y)) return;

            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.angle);

            ctx.beginPath();
            ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = this.isGas ? "rgba(255, 77, 77, 1.0)" : "#ff4d4d";
            ctx.fill();
            ctx.strokeStyle = "#800000";
            ctx.lineWidth = 1.5;
            ctx.stroke();

            // H2O åˆ†å­ç´°ç¯€
            const hDist = this.radius * 1.1;
            const hRad = this.radius * 0.6;
            const hAngle = 2.0; 

            ctx.beginPath();
            ctx.arc(Math.cos(-hAngle/2)*hDist, Math.sin(-hAngle/2)*hDist, hRad, 0, Math.PI*2);
            ctx.fillStyle = "#ffffff"; ctx.fill(); ctx.stroke();

            ctx.beginPath();
            ctx.arc(Math.cos(hAngle/2)*hDist, Math.sin(hAngle/2)*hDist, hRad, 0, Math.PI*2);
            ctx.fillStyle = "#ffffff"; ctx.fill(); ctx.stroke();

            ctx.restore();
        }
    }

    // =========================================
    // ç³»çµ±ç®¡ç†
    // =========================================

    function init() {
        particles = [];
        for (let i = 0; i < NUM_PARTICLES; i++) {
            particles.push(new Particle(i));
        }
        resize();
        window.addEventListener('resize', resize);
        requestAnimationFrame(loop);
        updatePhaseState(true);
    }

    function resize() {
        const container = document.getElementById('sim-container');
        if (!container) return;
        const rect = container.getBoundingClientRect();
        const dpr = Math.min(window.devicePixelRatio || 1, 2); 
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        scale = canvas.width / CONTAINER_WIDTH;
        ctx.setTransform(1, 0, 0, 1, 0, 0); 
        ctx.scale(scale, scale);
    }

    function resolveCollisions() {
        // [åƒæ•¸èª¿æ•´]
        let spacingFactor = 3.2; 
        if (temperature <= 0) spacingFactor = 4.0;
        else if (currentPhase === 'gas') spacingFactor = 3.0;

        const minDist = PARTICLE_RADIUS * spacingFactor;
        const minDistSq = minDist * minDist;

        for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
                const p1 = particles[i];
                const p2 = particles[j];
                
                const dx = p2.x - p1.x;
                const dy = p2.y - p1.y;
                const distSq = dx*dx + dy*dy;

                if (distSq < minDistSq && distSq > 0) {
                    const dist = Math.sqrt(distSq);
                    const nx = dx / dist;
                    const ny = dy / dist;
            
                    // å›ºæ…‹æ¨åŠ›å°ï¼Œæ¶²é«”æ¨åŠ›é©ä¸­
                    let pushStrength = 0.5; 
                    if (temperature <= 0) pushStrength = 0.1;

                    const overlap = (minDist - dist) * pushStrength;

                    p1.x -= nx * overlap; p1.y -= ny * overlap;
                    p2.x += nx * overlap; p2.y += ny * overlap;

                    if (temperature <= 0) continue;

                    // å‹•é‡äº¤æ›
                    let restitution = 0.2; 
                    // æ°£é«”ä¹‹é–“å½ˆæ€§å¥½ï¼Œæ°£æ¶²ä¹‹é–“ä¹Ÿçµ¦ä¸€é»å½ˆæ€§è®“å®ƒèƒ½å½ˆé–‹
                    if (p1.isGas || p2.isGas) restitution = 1.0; 
					else if (p1.isGas || p2.isGas) restitution = 0.8;

                    const v1n = p1.vx * nx + p1.vy * ny;
                    const v2n = p2.vx * nx + p2.vy * ny;
            
                    if (v1n < v2n) continue;

                    const impulse = (v2n - v1n) * (1 + restitution) * 0.5;
                    p1.vx += impulse * nx; p1.vy += impulse * ny;
                    p2.vx -= impulse * nx; p2.vy -= impulse * ny;
                    
                    // ç¢°æ’å¾Œçš„é˜»å°¼ (ç©©å®šå †ç–Š)
                    if (!p1.isGas && !p2.isGas) {
                        p1.vx *= 0.99; p1.vy *= 0.99;
                        p2.vx *= 0.99; p2.vy *= 0.99;
                    }
                }
            }
        }
    }

    function updatePhaseState(forceReset = false) {
        let nextPhase = '';
        if (temperature <= 0) nextPhase = 'solid';
        else if (temperature < 100) nextPhase = 'liquid';
        else nextPhase = 'gas';

        if (nextPhase !== currentPhase || forceReset) {
            currentPhase = nextPhase;
            const btns = document.querySelectorAll('.state-btn');
            if(btns) btns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.state === currentPhase);
            });
            
            if (currentPhase === 'solid') {
                particles.forEach(p => p.anchored = false);
            }
        }
    }

    function loop() {
        ctx.save();
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // èƒŒæ™¯ç¹ªè£½
        if (temperature <= 0) {
            const alpha = Math.min(0.8, Math.abs(temperature)/50);
            ctx.fillStyle = `rgba(200, 230, 255, ${0.3 + alpha * 0.2})`;
        } else if (temperature >= 100) {
            const alpha = Math.min(1.0, (temperature - 100) / 150);
            ctx.fillStyle = `rgba(255, 210, 190, ${0.15 + alpha * 0.35})`;
        } else {
            ctx.fillStyle = "#f8f9fa";
        }
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.restore();

        // 1. æ§æº«
        if (heatPower !== 0) {
            let changeRate = 0.2;
			if (heatPower < 0) {
				let dist = temperature - (-273);
				let damping = Math.min(1.0, dist / 70) + 0.05;
				changeRate *= damping;
			}
			
            temperature += heatPower * changeRate;
            if (temperature > 600) temperature = 600;
            if (temperature < -273) temperature = -273;
            
            const tempEl = document.getElementById('tempValue');
            if(tempEl) tempEl.innerText = Math.round(temperature);
            updatePhaseState();
        }

        // 2. ç‰©ç†æ›´æ–° (5æ¬¡å¾®æ­¥ï¼Œç©©å®šå †ç–Š)
        const SUB_STEPS = 5; 
        const subDt = 1.0 / SUB_STEPS;

        for (let s = 0; s < SUB_STEPS; s++) {
            particles.forEach(p => p.update(subDt));
            const solverIterations = 2; 
            for(let k = 0; k < solverIterations; k++) {
                resolveCollisions();
            }
        }

        // 3. ç¹ªè£½
        particles.forEach(p => p.draw(ctx));

        requestAnimationFrame(loop);
    }

    // UI ç¶å®š
    const lever = document.getElementById('heatLever');
    if (lever) {
        lever.addEventListener('input', (e) => {
            heatPower = parseInt(e.target.value) / 100;
        });
        function resetLever() { lever.value = 0; heatPower = 0; }
        lever.addEventListener('change', resetLever);
        lever.addEventListener('mouseup', resetLever);
        lever.addEventListener('touchend', resetLever);
    }

    window.setMode = function(mode) {
        switch(mode) {
            case 'solid': temperature = -20; break;
            case 'liquid': temperature = 25; break;
            case 'gas': temperature = 150; break;
        }
        if(lever) { lever.value = 0; heatPower = 0; }
        const tempEl = document.getElementById('tempValue');
        if(tempEl) tempEl.innerText = Math.round(temperature);
        updatePhaseState(true);
    }

    init();
</script>
</body>
</html>