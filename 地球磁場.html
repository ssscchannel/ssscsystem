<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€åœ°çƒç£å ´çš„ç£åŠ›ç·šæ¨¡æ“¬</title>
    
    <style>
        /* =========================================
           1. å…¬ç‰ˆæ ¸å¿ƒæ¨£å¼ (Template V3)
           ========================================= */
        html, body {
            margin: 0; padding: 0; width: 100%;
            height: 100dvh;
            overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
            
            background-color: #000;
            background-image: 
                linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), 
                url('page.jpg'); 
            background-size: cover; background-position: center;
            
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        .app-layout-wrapper {
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
            margin: 0 auto;
        }

        /* [Header] è—ç´…é»ƒæ¼¸å±¤ */
        .main-header {
            flex-shrink: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(90deg, #1a2a6c, #b21f1f, #fdbb2d);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-sizing: border-box;
            color: white;
        }

        .logo-area {
            width: 40px; height: 40px;
            background-color: white;
            border-radius: 50%; /* åœ“å½¢ */
            margin-right: 15px;
            background-image: url('logo.jpg');
            background-size: cover;
            border: 2px solid #00d2ff;
            flex-shrink: 0;
        }

        .header-title {
            flex: 1;
            font-size: 1.0rem;
            font-weight: bold;
            color: white; /* ç™½è‰² */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            white-space: normal;
            line-height: 1.2;
        }

        .line-btn {
            margin-left: auto;
            background-color: #00B900;
            color: white;
            text-decoration: none;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.5);
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        /* [Footer] åº•éƒ¨å€åŸŸ - åŒæ¨£æ¼¸å±¤ */
        .main-footer {
            flex: 0 0 auto;
            width: 100%;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 100;
            padding: 15px;  /* ä¸Šå·¦å³ä¿æŒ 15px */
            
            /* é—œéµèªæ³•ï¼šåŸºç¤ 20px ç©ºéš™ + æ‰‹æ©Ÿåº•éƒ¨å®‰å…¨å€(è‹¥æœ‰çš„è©±) */
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            
            box-sizing: border-box;
            
            display: flex; /* ç¢ºä¿å…§å®¹å°é½Š */
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            gap: 10px; /* å…ƒä»¶ä¹‹é–“çš„é–“è· */
        }

        /* =========================================
           2. æ¨¡æ“¬å€å¡Šæ¨£å¼
           ========================================= */
        #simulation-area {
            flex-grow: 1; 
            width: 100%; 
            position: relative;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        .simulation-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            /* èƒŒæ™¯ç¶­æŒé€æ˜æˆ–å¾®é€ï¼Œè®“æ˜Ÿç©ºåœ–å¯è¦‹ */
            background: rgba(20, 30, 40, 0.3); 
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        canvas {
            width: 100%; height: 100%;
            touch-action: none;
            position: absolute; top: 0; left: 0;
        }

        /* å…§éƒ¨æç¤º */
        .internal-instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.9); font-size: 1.1rem; font-weight: bold;
            pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.4);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 10;
        }

        /* æ§åˆ¶æŒ‰éˆ•æ¨£å¼ - ä¿®æ”¹ç‚ºé•·å½¢åœ“è§’ */
        .toggle-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            text-align: center;
            box-sizing: border-box;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .toggle-btn:active { 
            transform: scale(0.97); 
        }

        /* æ–¹ä½é›·é” (ç¶­æŒå³ä¸Šè§’) */
        .radar-widget {
            position: absolute;
            right: 20px;
            top: 60px;
            width: 50px; height: 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: none;
            background: radial-gradient(circle, transparent 40%, rgba(255, 255, 255, 0.1) 100%);
            z-index: 10;
        }
        .radar-widget::before { content:''; position: absolute; top: 5px; bottom: 5px; left: 50%; width: 1px; background: rgba(255,255,255,0.2); }
        .radar-widget::after { content:''; position: absolute; left: 5px; right: 5px; top: 50%; height: 1px; background: rgba(255,255,255,0.2); }
        .radar-label { position: absolute; font-size: 10px; font-weight: bold; color: rgba(255,255,255,0.6); line-height: 1; }
        .label-n { top: 2px; left: 50%; transform: translateX(-50%); color: #ff5555; }
        .label-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .label-e { right: 4px; top: 50%; transform: translateY(-50%); }
        .label-w { left: 4px; top: 50%; transform: translateY(-50%); }

    </style>
</head>
<body>

    <div class="app-layout-wrapper">
        
        <header class="main-header">
            <a href="index.html" class="logo-area" title="è¿”å›å¤§å»³"></a>
            <div class="header-title">æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±<br>åœ°çƒç£å ´çš„ç£åŠ›ç·šæ¨¡æ“¬</div>
            <a href="https://line.me/ti/g2/TTCqPpZP6lQqX1z_AUDPNm4977Dvylew3O7oBg" target="_blank" class="line-btn">
                åŠ  LINE è¨è«–
            </a>
        </header>

        <div id="simulation-area">
            <div class="simulation-container" id="sim-container">
                <canvas id="simCanvas"></canvas>
                
                <div class="internal-instruction">ğŸ’¡ è«‹ä»»æ„ç§»å‹•ç£é‡</div>
                
                <div class="radar-widget">
                    <div class="radar-label label-n">N</div>
                    <div class="radar-label label-e">E</div>
                    <div class="radar-label label-s">S</div>
                    <div class="radar-label label-w">W</div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <div class="toggle-btn active" id="btn-magnet" onclick="toggleLayer('magnet')">åœ°ç£</div>
        </footer>

    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        const LOGICAL_SIZE = 1000;
        const R_EARTH = 320; 
        const ORBIT_R = R_EARTH + 75; 

        const FONTS = {
            pole: "bold 50px Arial",        
            label: "bold 36px Microsoft JhengHei", 
            geo: "bold 36px Microsoft JhengHei"    
        };

        const state = { magnet: true };
        const MAG_TILT = -11.9 * (Math.PI / 180); 
        
        let compassPos = { x: ORBIT_R, y: 0 }; 
        let compassAngle = -Math.PI / 2; 
        let isDragging = false;
        let flowParticles = [];
        
        let renderScale = 1;
        let renderOffsetX = 0;
        let renderOffsetY = 0;

        function resize() {
            // [ä¿®æ­£] æ”¹ç‚ºåµæ¸¬ simulation-container å¤§å°
            const container = document.getElementById('sim-container');
            const w = container.clientWidth;
            const h = container.clientHeight;
            const dpr = window.devicePixelRatio || 1;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            ctx.scale(dpr, dpr);
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            const minDim = Math.min(w, h);
            renderScale = (minDim * 0.95) / LOGICAL_SIZE;
            renderOffsetX = w / 2;
            renderOffsetY = h / 2;
        }
        window.addEventListener('resize', resize);
        
        function init() {
            resize(); 
            for(let i=0; i<60; i++) {
                flowParticles.push({
                    t: Math.random(),
                    lineIndex: Math.floor(Math.random() * 6), 
                    speed: 0.002 + Math.random() * 0.003
                });
            }
            updateCompassPhysics(ORBIT_R, 0); 
            requestAnimationFrame(loop);
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        function update() {
            for (let p of flowParticles) {
                p.t += p.speed;
                if(p.t > 1) p.t = 0;
            }
        }

        function draw() {
            const w = canvas.width / (window.devicePixelRatio || 1);
            const h = canvas.height / (window.devicePixelRatio || 1);
            ctx.clearRect(0, 0, w, h);

            drawStars(w, h);

            ctx.save();
            ctx.translate(renderOffsetX, renderOffsetY);
            ctx.scale(renderScale, renderScale);

            drawEarth();
            drawGeoMarkers(); 
            
            ctx.save(); 
            ctx.rotate(MAG_TILT); 
                if (state.magnet) {
                    drawInternalMagnet();   
                    drawMagneticFields();   
                    drawMagAxis();          
                }
            ctx.restore(); 

            drawCompassClean();
            ctx.restore(); 
        }

        function drawStars(w, h) {
            ctx.fillStyle = "rgba(255,255,255,0.6)";
            const starCount = 40;
            let rand = (n) => { return Math.abs(Math.sin(n * 12.9898) * 43758.5453) % 1; };
            for(let i=0; i<starCount; i++) {
                const x = rand(i) * w;
                const y = rand(i*2) * h;
                const r = rand(i*3) * 1.5 + 0.5;
                ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();
            }
        }

        function drawEarth() {
            const grad = ctx.createRadialGradient(0, 0, R_EARTH, 0, 0, R_EARTH + 50);
            grad.addColorStop(0, "rgba(0, 150, 255, 0.3)");
            grad.addColorStop(1, "rgba(0, 150, 255, 0)");
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.arc(0, 0, R_EARTH + 50, 0, Math.PI*2); ctx.fill();

            ctx.fillStyle = state.magnet ? "rgba(10, 20, 35, 0.9)" : "#0b1d2e";
            ctx.strokeStyle = "#2980b9";
            ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(0, 0, R_EARTH, 0, Math.PI * 2); ctx.fill(); ctx.stroke();

            ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, -R_EARTH); ctx.lineTo(0, R_EARTH); ctx.stroke();
            ctx.beginPath(); ctx.ellipse(0, 0, R_EARTH, R_EARTH*0.35, 0, 0, Math.PI*2); ctx.stroke();
        }

        function drawGeoMarkers() {
            const R_GEO_LABEL_Y = R_EARTH + 35; 
            const R_GEO_LABEL_X = 150;          
            const AXIS_LEN = R_EARTH + 140; 

			ctx.strokeStyle = "rgba(255,255,255,0.3)";
            ctx.lineWidth = 2;
            ctx.setLineDash([15, 15]); 
            ctx.beginPath(); ctx.moveTo(0, -AXIS_LEN); ctx.lineTo(0, AXIS_LEN); ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = "#fff";
            ctx.font = FONTS.label;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("è‡ªè½‰è»¸", 0, -AXIS_LEN - 30); 

            ctx.fillStyle = "rgba(255,255,255,0.8)";
            ctx.fillRect(-3, -R_EARTH-3, 6, 6);
            ctx.fillRect(-3, R_EARTH-3, 6, 6);

            ctx.font = FONTS.geo;
            
            ctx.textAlign = "left"; 
            ctx.fillText("åœ°ç†åŒ—æ¥µ(æ­£åŒ—)", R_GEO_LABEL_X, -R_GEO_LABEL_Y); 
            drawCuteArrow(0, -R_EARTH - 5, R_GEO_LABEL_X - 10, -R_GEO_LABEL_Y, "#fff");

            ctx.textAlign = "right"; 
            ctx.fillText("åœ°ç†å—æ¥µ", -R_GEO_LABEL_X, R_GEO_LABEL_Y);
            drawCuteArrow(0, R_EARTH + 5, -R_GEO_LABEL_X + 10, R_GEO_LABEL_Y, "#fff");
        }

        function drawInternalMagnet() {
            const w = 70, h = 380;
            ctx.fillStyle = "#27ae60"; ctx.fillRect(-w/2, -h/2, w, h/2);
            ctx.strokeStyle = "#fff"; ctx.lineWidth=2; ctx.strokeRect(-w/2, -h/2, w, h/2);
            ctx.fillStyle = "#c0392b"; ctx.fillRect(-w/2, 0, w, h/2);
            ctx.strokeRect(-w/2, 0, w, h/2);

            drawLabelAt(0, -h/4, "S", FONTS.pole, "#fff");
            drawLabelAt(0, h/4, "N", FONTS.pole, "#fff");
            
            const northMarkerY = -R_EARTH;
            const southMarkerY = R_EARTH;

            ctx.beginPath(); ctx.fillStyle = "#2ecc71"; 
            ctx.arc(0, northMarkerY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            
            ctx.beginPath(); ctx.fillStyle = "#e74c3c"; 
            ctx.arc(0, southMarkerY, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();

            const labelNx = -150; 
            const labelNy = -R_EARTH - 35;
            const labelSx = 150;  
            const labelSy = R_EARTH + 35;

            drawLabelAt(labelNx, labelNy, "åœ°ç£åŒ—æ¥µ", FONTS.label, "#f1c40f");
            drawLabelAt(labelSx, labelSy, "åœ°ç£å—æ¥µ", FONTS.label, "#f1c40f");

            drawCuteArrow(0, northMarkerY - 10, labelNx + 70, labelNy + 10, "#f1c40f"); 
            drawCuteArrow(0, southMarkerY + 10, labelSx - 70, labelSy - 10, "#f1c40f"); 
        }

        function drawCuteArrow(x1, y1, x2, y2, color) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            
            const cpX = (x1 + x2) / 2;
            const curvature = (x2 - x1) * 0.2; 
            const cpY = y1 + Math.abs(curvature) * (y1 < 0 ? 0.2 : -0.2); 
            
            ctx.moveTo(x1, y1);
            ctx.quadraticCurveTo(cpX, cpY, x2, y2);
            ctx.stroke();

			ctx.save();
            ctx.translate(x2, y2);
            
			const angle = Math.atan2(y2 - cpY, x2 - cpX);
            ctx.rotate(angle);
            
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-20, -12); 
            ctx.lineTo(-20, 12);
            ctx.fill();
            ctx.restore();
        }

        function drawMagAxis() {
            ctx.beginPath();
            ctx.strokeStyle = "rgba(241, 196, 15, 0.6)"; 
            ctx.setLineDash([15, 15]); ctx.lineWidth = 2;
            const axisLen = R_EARTH + 140;
            ctx.moveTo(0, -axisLen); 
            ctx.lineTo(0, axisLen); 
            ctx.stroke();
            ctx.setLineDash([]);
            
            drawLabelAt(0, -axisLen - 30, "ç£è»¸", FONTS.label, "#f1c40f", "center");
        }

        function drawLabelAt(lx, ly, text, font, color, align = "center") {
            ctx.save();
            ctx.translate(lx, ly);    
            ctx.rotate(-MAG_TILT); 
            
            ctx.font = font;
            ctx.fillStyle = color;
            ctx.textAlign = align;
            ctx.textBaseline = "middle";
            ctx.shadowColor = "rgba(0,0,0,0.8)";
            ctx.shadowBlur = 4;
            
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }

        function drawMagneticFields() {
            ctx.strokeStyle = "rgba(0, 210, 255, 0.2)";
            ctx.lineWidth = 2;
            const scales = [1.6, 2.5, 4.0]; 
            scales.forEach((s, idx) => {
                drawSingleLine(-s, idx);      
                drawSingleLine(s, idx + 3);   
            });
        }

        function drawSingleLine(scaleX, idx) {
            const startY = R_EARTH; 
            const endY = -R_EARTH;
            const cpX = R_EARTH * scaleX;
            
            const bulge = Math.abs(cpX) * 0.6;
            const cpY_Start = startY + bulge; 
            const cpY_End = endY - bulge;    

            ctx.beginPath();
            ctx.moveTo(0, startY);
            ctx.bezierCurveTo(cpX, cpY_Start, cpX, cpY_End, 0, endY);
            ctx.stroke();

            ctx.fillStyle = "rgba(255,255,255,0.9)";
            for(let p of flowParticles) {
                if(p.lineIndex === idx) {
                    const t = p.t;
                    const x = bezier(0, cpX, cpX, 0, t);
                    const y = bezier(startY, cpY_Start, cpY_End, endY, t);
                    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
                }
            }
        }
        function bezier(p0, p1, p2, p3, t) {
            const m = 1-t;
            return m*m*m*p0 + 3*m*m*t*p1 + 3*m*t*t*p2 + t*t*t*p3;
        }

        function updateCompassPhysics(worldX, worldY) {
            const cosT = Math.cos(-MAG_TILT);
            const sinT = Math.sin(-MAG_TILT);
            const rx = worldX * cosT - worldY * sinT;
            const ry = worldX * sinT + worldY * cosT;
            const r2 = rx*rx + ry*ry;
            const r = Math.sqrt(r2);
            
            const bx = 3 * rx * ry;
            const by = 2 * ry * ry - rx * rx;
            const bLen = Math.sqrt(bx*bx + by*by);
            const bx_norm = bx / bLen;
            const by_norm = by / bLen;

            const t1x = -ry; const t1y = rx;
            const t2x = ry;  const t2y = -rx;
            
            const dot1 = t1x*bx_norm + t1y*by_norm;
            let tx_final, ty_final;
            
            if (dot1 > 0) { tx_final = t1x; ty_final = t1y; }
            else { tx_final = t2x; ty_final = t2y; }
            
            const tLenFinal = Math.sqrt(tx_final*tx_final + ty_final*ty_final);
            const tx_norm = tx_final / tLenFinal;
            const ty_norm = ty_final / tLenFinal;

            const absSinLat = Math.abs(ry) / r;
            
            let factor = 0; 
            if (absSinLat < 0.5) factor = 0;
            else if (absSinLat > 0.985) factor = 1;
            else factor = (absSinLat - 0.5) / (0.485);

            const final_x = tx_norm * (1 - factor) + bx_norm * factor;
            const final_y = ty_norm * (1 - factor) + by_norm * factor;

            const angle_mag = Math.atan2(final_y, final_x);
            compassAngle = angle_mag + MAG_TILT;
        }

        function drawCompassClean() {
            const cx = compassPos.x;
            const cy = compassPos.y;

            if (isDragging) {
                ctx.save();
                ctx.strokeStyle = "rgba(255, 50, 50, 0.3)";
                ctx.setLineDash([5, 5]); ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(0, 0); ctx.stroke();
                ctx.restore();
            }

            ctx.save();
            ctx.translate(cx, cy);
            ctx.rotate(compassAngle);
            
            const size = 10, len = 50; 
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-size, -14); ctx.lineTo(len, 0); ctx.lineTo(-size, 14);
            ctx.fillStyle = "#ff3333"; ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-size, -14); ctx.lineTo(-len, 0); ctx.lineTo(-size, 14);
            ctx.fillStyle = "#e0e0e0"; ctx.fill();
            ctx.fillStyle = "#111"; ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill();
            ctx.save(); ctx.rotate(-Math.PI/2); ctx.fillStyle = "rgba(255,255,255,0.9)";
            ctx.font = "bold 28px sans-serif"; ctx.fillText("N", 24, 36); ctx.restore();
            ctx.restore();
        }

        window.toggleLayer = function(key) {
            if (key === 'magnet') {
                state.magnet = !state.magnet;
                const btn = document.getElementById('btn-magnet');
                if(btn) btn.classList.toggle('active');
            }
        };

        function getLogicalPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches && e.touches.length > 0 ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches && e.touches.length > 0 ? e.touches[0].clientY : e.clientY;
            if (clientX === undefined) return {x:0, y:0};
            const screenX = clientX - rect.left;
            const screenY = clientY - rect.top;
            return {
                x: (screenX - renderOffsetX) / renderScale,
                y: (screenY - renderOffsetY) / renderScale
            };
        }

        function onDown(e) {
            isDragging = true;
            const pos = getLogicalPos(e);
            updateCompassPosition(pos.x, pos.y);
            if(e.cancelable) e.preventDefault(); 
        }

        function onMove(e) {
            if(!isDragging) return;
            if(e.cancelable) e.preventDefault();
            const pos = getLogicalPos(e);
            updateCompassPosition(pos.x, pos.y);
        }
        
        function updateCompassPosition(tx, ty) {
            const ang = Math.atan2(ty, tx);
            compassPos.x = Math.cos(ang) * ORBIT_R;
            compassPos.y = Math.sin(ang) * ORBIT_R;
            updateCompassPhysics(compassPos.x, compassPos.y);
        }

        function onUp(e) {
            isDragging = false;
        }

        canvas.addEventListener('mousedown', onDown);
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
        canvas.addEventListener('touchstart', onDown, {passive: false});
        window.addEventListener('touchmove', onMove, {passive: false});
        window.addEventListener('touchend', onUp);

        init();
    </script>
</body>

</html>
