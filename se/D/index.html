<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€é©—é›»å™¨</title>
    
    <style>
        /* =========================================
           1. å…¨å±€è¨­å®š
           ========================================= */
        :root {
            --ground-color: #27ae60;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-image: url('page.jpg'); 
            background-size: cover;
            background-position: center;
            background-color: #f0f2f5;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            touch-action: none;
            user-select: none;
        }

        /* =========================================
           2. æ¨™é¡Œå€
           ========================================= */
        .header-container {
            flex-shrink: 0;
            width: 97%;
            box-sizing: border-box;
            max-width: 800px;
            display: flex;
            justify-content: space-between; 
            align-items: center;
            padding: 8px 15px;
            margin-top: 5px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 1000;
        }

        .header-container h1 {
            margin: 0;
            font-size: 1.1rem;
            color: #333;
            line-height: 1.3;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        .title-logo { height: 36px; width: auto; border-radius: 4px; }

        .header-btn {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            background: #06c755;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            white-space: nowrap;
        }
        .header-btn:active { transform: scale(0.95); }
        .header-btn span { margin-right: 4px; }

        /* =========================================
           3. æ¨¡æ“¬å€
           ========================================= */
        #sim-container {
            flex: 1; 
            width: 100%;
            position: relative;
            overflow: hidden;
            cursor: default;
        }

        canvas { display: block; width: 100%; height: 100%; }

        .instruction-tag {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 24px;
            border-radius: 50px;
            font-size: 0.95rem;
            color: #555;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            pointer-events: none; 
            white-space: nowrap;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            z-index: 10;
        }
        .instruction-tag.highlight { color: #2c3e50; border: 2px solid #3498db; background: #fff; }
        .instruction-tag.success { color: #fff; background: var(--ground-color); border-color: var(--ground-color); }

        /* =========================================
           4. åº•éƒ¨æ§åˆ¶å€
           ========================================= */
        .controls {
            flex: 0 0 auto;
            width: 100%;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(0,0,0,0.1);
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .controls-left, .controls-right { display: flex; align-items: center; }

        .switch-capsule {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #f1f3f5;
            border-radius: 100px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.06);
            padding: 5px 15px; 
            gap: 10px;
        }

        .btn-toggle {
            width: 44px; height: 44px;
            border: none; border-radius: 50%;
            font-size: 1.5rem; font-weight: 800;
            cursor: pointer;
            background: transparent; color: #bdc3c7;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-toggle:active { transform: scale(0.95); }
        .btn-toggle.active-neg { background: #3498db; color: white; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4); }
        .btn-toggle.active-pos { background: #e74c3c; color: white; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4); }
		.btn-toggle.active-contact { 
            background: #f1c40f; 
            color: #fff; 
            border-color: #f1c40f; 
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); 
            transform: scale(1.05);
        }
        .btn-toggle:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-toggle.btn-ground { color: #95a5a6; border: 2px solid #ecf0f1; }
        .btn-toggle.btn-ground:active { background: var(--ground-color); color: white; border-color: var(--ground-color); }
        
        .btn-reset-icon { font-size: 1.4rem; color: #e74c3c; }
        .btn-reset-icon:hover { background: rgba(231, 76, 60, 0.1); }

        .deck-label { font-size: 0.9rem; font-weight: 700; color: #666; white-space: nowrap; margin-right: 5px; }
        .divider { width: 1px; height: 24px; background: #cbd5e0; margin: 0 2px; }

        .btn-return {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: #fff;
            color: #555;
            display: flex; align-items: center; justify-content: center;
            text-decoration: none;
            font-size: 1.4rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            border: 1px solid rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .btn-return:active { transform: scale(0.9); background: #f0f0f0; }

        @media (max-width: 600px) {
            .header-container h1 { font-size: 1rem; }
            .header-btn span { display: none; }
            .switch-capsule { padding: 4px 10px; gap: 5px; }
            .deck-label { display: none; }
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>
            <img src="logo.jpg" alt="Logo" class="title-logo" onerror="this.style.display='none'">
            <div>æ™Ÿè‡ªç„¶è¼”åŠ©ç³»çµ±ã€€é©—é›»å™¨</div>
        </h1>
        <div class="nav-buttons">
            <a href="https://line.me/ti/g2/TTCqPpZP6lQqX1z_AUDPNm4977Dvylew3O7oBg" target="_blank" class="header-btn">
                <span>ğŸ‘‰</span>åŠ  LINE æå•
            </a>       
        </div>
    </div>

    <div id="sim-container">
        <div class="instruction-tag" id="infoTag">æ­¥é©Ÿ1ï¼šè«‹æ‹–æ›³å¸¶é›»æ£’é è¿‘é©—é›»å™¨</div>
        <canvas id="simCanvas"></canvas>
    </div>

    <div class="controls">
        <div class="controls-left">
            <div class="switch-capsule">
                <span class="deck-label">å¸¶é›»æ£’</span>
                <button class="btn-toggle active-neg" id="btnNeg" onclick="APP.setRod(-1)">ï¼</button>
                <button class="btn-toggle" id="btnPos" onclick="APP.setRod(1)">ï¼‹</button>
                <div class="divider"></div>    
                <button class="btn-toggle btn-ground" id="btnGround" onclick="APP.triggerGround()" title="æ¥åœ° (è§¸ç™¼)">ğŸ–</button>
                <button class="btn-toggle" id="btnContact" onclick="APP.toggleContact()" disabled title="æ¥è§¸ (éœ€å…ˆé è¿‘)">âš¡</button>
				<button class="btn-toggle btn-reset-icon" onclick="APP.hardReset()" title="é‡ç½®">â†º</button>				
            </div>
        </div>

        <div class="controls-right">
            <a href="index.html" class="btn-return" title="è¿”å›é¦–é ">â†©</a>
        </div>
    </div>

    <script>
    /**
     * Project D Final v9.6: Dynamic Actor Correction
     * 1. ä¿®æ­£é›»è·æ“´æ•£æ™‚çš„è¦–è¦ºé‚è¼¯ï¼šä¸å†å¼·åˆ¶é–å®šè³ªå­ä½ç½®ã€‚
     * 2. å¼•å…¥å‹•æ…‹ä»£ç†æ©Ÿåˆ¶ï¼šç‰©ç†é‹ç®—ç”± Electron è®Šæ•¸çµ±ä¸€è™•ç†ï¼Œé¡¯ç¤ºå±¤æ ¹æ“šé›»è·æ¥µæ€§å‹•æ…‹åˆ†é…ã€‚
     * 3. ç¢ºä¿æ­£/è² é›»æ£’åœ¨æ¥åœ°å¾Œç§»é–‹æ™‚ï¼Œç•«é¢ä¸Šçš„é›»è·çš†èƒ½æ­£ç¢ºå¾é‡‘å±¬ç›¤æµå‘é‡‘ç®”ã€‚
     */
    const APP = {
        canvas: null, ctx: null, wrapper: null,
        width: 0, height: 0, dpr: 1,

        config: {
            globalScale: 1.0,      
            bottleSizeMult: 1.3,
            rodSizeMult: 0.7,
            pairCount: 100,     
            particleRadius: 3.5,
            maxLeafAngle: 2.3, 
            leafLengthBase: 65,
            railStart: {x:0, y:0},
            railEnd: {x:0, y:0},
            inductionLimit: 0 
        },

        rod: { x: 0, y: 0, charge: -1, dragging: false, angle: -Math.PI/4 },
        electroscope: { x: 0, y: 0, leafAngle: 0, isGrounded: false },
		contact: { active: false, done: false, type: 0, lastPos: {x:0, y:0} },
        particlePairs: [],

        init: function() {
            this.wrapper = document.getElementById('sim-container');
            this.canvas = document.getElementById('simCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.dpr = window.devicePixelRatio || 1;

            const bind = (evts, handler) => evts.forEach(e => this.canvas.addEventListener(e, handler, {passive: false}));
            bind(['mousedown', 'mousemove', 'mouseup', 'mouseleave'], e => this.handleMouse(e));
            bind(['touchstart', 'touchmove', 'touchend'], e => this.handleTouch(e));

            window.addEventListener('resize', () => this.resize());
            this.resize();
            this.initParticles();
            this.hardReset();
            this.loop();
        },

        resize: function() {
            const rect = this.wrapper.getBoundingClientRect();
            this.width = rect.width;
            this.height = rect.height;
            this.canvas.width = this.width * this.dpr;
            this.canvas.height = this.height * this.dpr;
            this.ctx.scale(this.dpr, this.dpr);

            let baseScale = Math.min(this.width / 380, this.height / 600);
            this.config.globalScale = baseScale;

            this.electroscope.x = this.width / 2;
            this.electroscope.y = this.height * 0.65;
            
            let s = baseScale * this.config.bottleSizeMult;
            let plateY = this.electroscope.y - 140 * s;

            this.config.railEnd = { x: this.electroscope.x + 80 * s, y: plateY - 45 * s };
            this.config.railStart = { x: this.width * 0.92, y: this.height * 0.08 };

            let rs = baseScale * this.config.rodSizeMult;
            let startAngle = Math.atan2(plateY - this.config.railStart.y, this.electroscope.x - this.config.railStart.x);
            let startTipX = this.config.railStart.x + Math.cos(startAngle) * 60 * rs;
            let startTipY = this.config.railStart.y + Math.sin(startAngle) * 60 * rs;
            this.config.inductionLimit = Math.hypot(startTipX - this.electroscope.x, startTipY - plateY) + 10;
            
            if (!this.rod.dragging) this.forceRodToStart();
        },

        initParticles: function() {
            this.particlePairs = [];
            let count = this.config.pairCount;
            let goldenAngle = Math.PI * (3 - Math.sqrt(5));
            this.plateSeats = [];
            
            for(let i=0; i<count; i++) {
                let r = Math.sqrt((i + 0.5) / count); 
                let theta = i * goldenAngle;
                this.plateSeats.push({ x: r * Math.cos(theta), y: r * Math.sin(theta) });
            }

            for(let i=0; i<count; i++) {
                this.particlePairs.push({
                    id: i,
                    seatIndex: i,
                    leafLocalX: (Math.random() - 0.5), 
                    leafLocalY: 0.1 + Math.random() * 0.85, 
                    leafSide: (i % 2 === 0) ? 1 : -1, 
                    electron: { x: 0, y: 0, alpha: 0 },
                    proton: { x: 0, y: 0, alpha: 0 }
                });
            }
        },

        forceRodToStart: function() {
            this.rod.x = this.config.railStart.x;
            this.rod.y = this.config.railStart.y;
            let s = this.config.globalScale * this.config.bottleSizeMult;
            let plateY = this.electroscope.y - 140 * s;
            this.rod.angle = Math.atan2(plateY - this.rod.y, this.electroscope.x - this.rod.x);
        },

        hardReset: function() {
            // 1. ã€æ–°å¢ã€‘æ¸…é™¤æ¥è§¸ç›¸é—œçš„ç‹€æ…‹ (ä¿®æ­£å¤±æ•ˆçš„ä¸»å› )
            this.contact.active = false;
            this.contact.hasContacted = false;
            
            // 2. ã€æ–°å¢ã€‘é‡ç½®æ¥è§¸æŒ‰éˆ•çš„å¤–è§€
            const btnContact = document.getElementById('btnContact');
            if(btnContact) {
                btnContact.classList.remove('active-contact');
                // é‡ç½®æ™‚æ£’å­æœƒè¢«ç§»å›èµ·é»ï¼Œæ‰€ä»¥æŒ‰éˆ•ç†æ‡‰è®Šå›ä¸å¯æŒ‰çš„ç‹€æ…‹
                btnContact.disabled = true; 
            }

            // 3. åŸæœ¬çš„é‡ç½®é‚è¼¯ (ä¿æŒä¸è®Š)
            this.electroscope.leafAngle = 0;
            this.electroscope.isGrounded = false;
            this.rod.dragging = false;
            this.forceRodToStart();
            
            this.particlePairs.forEach(p => {
                p.electron.alpha = 0;
                p.proton.alpha = 0;
            });
            this.updateInfoTag(0);
            
            // 4. å¼·åˆ¶é‡ç¹ª (ç¢ºä¿ç•«é¢ç«‹åˆ»æ›´æ–°)
            this.draw();
        },

        triggerGround: function() {
            // 1. è¨ˆç®—ç›®å‰çš„æ„Ÿæ‡‰å¼·åº¦
            let strength = this.calculateInductionStrength();

            // 2. ã€æ–°å¢é‚è¼¯ã€‘æ”¾é›»æ¨¡å¼ (Discharge Mode)
            // å¦‚æœå¸¶é›»æ£’é›¢å¾—å¾ˆé  (å¼·åº¦ä¸è¶³ 0.3)ï¼Œæ­¤æ™‚æ¥åœ° = å°èµ°é›»è· = é‡ç½®
            if (strength <= 0.3) {
                this.hardReset(); // ç›´æ¥å‘¼å«é‡ç½®å‡½å¼ï¼Œæ¢å¾©é›»ä¸­æ€§
                return;
            }

            // 3. æ„Ÿæ‡‰æ¨¡å¼ (Induction Mode)
            // å¦‚æœå·²ç¶“åœ¨æ¥åœ°ç‹€æ…‹ï¼Œå°±ä¸é‡è¤‡è§¸ç™¼
            if (this.electroscope.isGrounded) return; 
            
            // åŸ·è¡ŒåŸæœ¬çš„æ„Ÿæ‡‰æ¥åœ°é‚è¼¯
            this.electroscope.isGrounded = true;
            this.electroscope.leafAngle = 0; 
            
            this.trappedCount = Math.floor(this.config.pairCount * strength);

            // é‡ç½®ç‰©ç†ä»£ç†äººä½ç½® (é˜²æ­¢é–ƒçˆ)
            let s = this.config.globalScale * this.config.bottleSizeMult;
            let plateY = this.electroscope.y - 140 * s;
            let cx = this.electroscope.x;

            this.particlePairs.forEach(pair => {
                let seat = this.plateSeats[pair.seatIndex % this.plateSeats.length];
                let platePos = { x: cx + seat.x * 65 * s, y: plateY + seat.y * 10 * s };
                
                pair.electron.x = platePos.x;
                pair.electron.y = platePos.y;
            });
        },

        calculateInductionStrength: function() {
            let s = this.config.globalScale * this.config.bottleSizeMult;
            let plateY = this.electroscope.y - 140 * s;
            let rs = this.config.globalScale * this.config.rodSizeMult;
            let rodTipX = this.rod.x + Math.cos(this.rod.angle) * 60 * rs;
            let rodTipY = this.rod.y + Math.sin(this.rod.angle) * 60 * rs;
            
            let dist = Math.hypot(rodTipX - this.electroscope.x, rodTipY - plateY);
            let limit = this.config.inductionLimit;
            let distToStart = Math.hypot(this.rod.x - this.config.railStart.x, this.rod.y - this.config.railStart.y);
            
            if (distToStart < 40 * s) return 0;
            if (dist < limit) {
                let raw = 1 - (dist / limit);
                return Math.pow(raw, 2.5); 
            }
            return 0;
        },

        update: function() {
            let strength = this.calculateInductionStrength();
            
            this.updateContactBtn(); 

            let targetAngle = 0;
            
            // ã€ä¿®æ­£é‡é»ã€‘å®šç¾©ç‰©ç†æ¥µé™è§’åº¦
            // åŸæœ¬çš„ 2.3 (ç´„130åº¦) å¤ªå¤§äº†ï¼Œæœƒå°è‡´é‡‘ç®”ç¿»éå»
            // æˆ‘å€‘æ”¹ç”¨ 1.4 (ç´„80åº¦)ï¼Œé€™æ˜¯è®“é‡‘ç®”å¼µé–‹åˆ°æ¥è¿‘æ°´å¹³çš„åˆç†æ¥µé™
            const limitAngle = 1.4; 

            // === é‡‘ç®”è§’åº¦è¨ˆç®—é‚è¼¯ ===

            // 1. æ¥è§¸å¸é™„ä¸­ (æœ€å¤§å¼µè§’)
            if (this.contact.active) {
                targetAngle = limitAngle;
            } 
            // 2. æ¥è§¸å¾Œæ–·é–‹ (ç¶­æŒå¼µè§’)
            else if (this.contact.hasContacted) {
                // è®“å¼µè§’åœ¨ 80% ~ 100% ä¹‹é–“æµ®å‹•
                targetAngle = (0.8 + 0.2 * strength) * limitAngle;
            }
            // 3. æ¥åœ°ç‹€æ…‹ (æ­¸é›¶)
            else if (this.electroscope.isGrounded) {
                if (strength > 0.2) {
                    targetAngle = 0; 
                } else {
                    let progress = (0.2 - strength) / 0.2;
                    progress = Math.max(0, Math.min(1, progress));
                    let ratio = (this.trappedCount || 0) / this.config.pairCount;
                    // é€™è£¡ä¹Ÿå¥—ç”¨ limitAngle ç¢ºä¿ä¸€è‡´æ€§
                    let finalAngle = limitAngle * ratio * 0.6;
                    targetAngle = finalAngle * progress; 
                }
            } 
            // 4. ä¸€èˆ¬æ„Ÿæ‡‰
            else {
                // å¥—ç”¨é™åˆ¶ï¼Œç¢ºä¿æ„Ÿæ‡‰æ™‚ä¹Ÿä¸æœƒç©¿æ¨¡
                targetAngle = strength * limitAngle;
            }
            
            // å‹•ç•«å¹³æ»‘åŒ–
            this.electroscope.leafAngle += (targetAngle - this.electroscope.leafAngle) * 0.3; 
            if (Math.abs(this.electroscope.leafAngle) < 0.001) this.electroscope.leafAngle = 0;

            this.updateParticles(strength);
            this.updateInfoTag(strength);
        },

        // ============================================
        // ä¿®æ­£ç‰ˆ v15: æ¥è§¸çš„ä¸­å’Œèˆ‡æ“´æ•£
        // ============================================
        updateParticles: function(strength) {
            let s = this.config.globalScale * this.config.bottleSizeMult;
            let cx = this.electroscope.x;
            let cy = this.electroscope.y;
            let plateY = cy - 140 * s; 
            let pivotY = cy + 60 * s; 
            let leafL = this.config.leafLengthBase * s; 
            let leafW = 6 * s;

            // --- åº§æ¨™è¨ˆç®—è¼”åŠ© ---
            const getPlatePos = (pair) => {
                let seat = this.plateSeats[pair.seatIndex % this.plateSeats.length];
                return { x: cx + seat.x * 65 * s, y: plateY + seat.y * 10 * s };
            };
            const getLeafPos = (pair) => {
                let angleVal = this.electroscope.leafAngle; 
                if(this.electroscope.isGrounded && angleVal < 0.1) angleVal = 0.1;

                let localX = (pair.leafSide===-1) ? (pair.leafLocalX-0.5)*leafW : (pair.leafLocalX+0.5)*leafW;
                let localY = leafL * pair.leafLocalY;
                let angle = (pair.leafSide===-1) ? -angleVal : angleVal;
                return { 
                    x: cx + (localX*Math.cos(angle) - localY*Math.sin(angle)), 
                    y: pivotY + (localX*Math.sin(angle) + localY*Math.cos(angle)) 
                };
            };

            let isNegRod = (this.rod.charge < 0);
            
            // === ã€ä¿®æ”¹é‡é»ã€‘å‹•æ…‹å¼·åº¦è¨ˆç®— ===
            
            // 1. å¦‚æœæ­£åœ¨æ¥è§¸ä¸­ (Active Contact)
            // ç‰©ç†æ„ç¾©ï¼šå¼·å‹¢é›»æºæ³¨å…¥ï¼Œå…¨åŠŸç‡è¼¸å‡º
            if (this.contact.active) {
                strength = 1.0; 
                this.contact.hasContacted = true; 
            } 
            // 2. å¦‚æœæ¥è§¸å¾Œæ–·é–‹ (Has Contacted)
            // ç‰©ç†æ„ç¾©ï¼šä¿æœ‰åŸºç¤é›»è·ï¼Œä¸¦éš¨è·é›¢ç”¢ç”Ÿæ„Ÿæ‡‰å¢æ¸› (å‘¼å¸æ•ˆæœ)
            else if (this.contact.hasContacted) {
                // å…¬å¼ï¼šåŸºç¤é›»è· 0.6 + æ„Ÿæ‡‰åŠ æˆ (0.4 * ç•¶å‰è·é›¢å¼·åº¦)
                // é€™æ¨£é é›¢æ™‚è‡³å°‘é‚„æœ‰ 0.6 (ä¸æœƒæ­¸é›¶)ï¼Œé è¿‘æ™‚æœƒè®Šå› 1.0
                strength = 0.6 + 0.4 * strength;
            }
            // 3. å¦‚æœåªæ˜¯å–®ç´”æ„Ÿæ‡‰ (æœªæ¥è§¸ã€æœªæ¥åœ°)
            // ä¿æŒåŸæœ¬å‚³é€²ä¾†çš„ strength (0~1) ä¸è®Š

            // è¨ˆç®—æ´»èºç²’å­æ•¸
            let activeCount = Math.floor(this.config.pairCount * strength);
            if (this.electroscope.isGrounded) {
                activeCount = (this.trappedCount !== undefined) ? this.trappedCount : activeCount;
            }

            this.particlePairs.forEach((pair, i) => {
                // 1. éš±è—éæ´»èºç²’å­ & è¨­å®šæ­£ç¢ºèµ·è·‘é»
                if (i >= activeCount) {
                    pair.proton.alpha = 0; pair.electron.alpha = 0;
                    
                    let startPos;

                    // ã€é—œéµä¿®æ­£ã€‘
                    // åˆ¤æ–·æ¢ä»¶åŠ å…¥ this.contact.hasContacted
                    // åªè¦æ˜¯ã€Œæ¥è§¸ä¸­ã€æˆ–æ˜¯ã€Œå¸¶é›»ç‹€æ…‹ã€ï¼Œç²’å­è®ŠåŒ–çš„æºé ­ä¸€å¾‹è¦–ç‚ºã€Œé‡‘å±¬ç›¤ã€
                    // é€™æ¨£ç•¶æ£’å­é è¿‘æ™‚ï¼Œé›»è·çœ‹èµ·ä¾†æœƒæ˜¯è¢«ã€Œå¾ç›¤å­å¾€ä¸‹æ“ å£“ã€çš„ (æ’æ–¥æ•ˆæœ)
                    if (this.contact.active || this.contact.hasContacted) {
                        startPos = getPlatePos(pair); 
                    } else {
                        // åªæœ‰åœ¨ç´”æ„Ÿæ‡‰æ¨¡å¼(æœªæ¥è§¸)ä¸‹ï¼Œæ‰å€åˆ†æ­£è² æ£’çš„èµ·å§‹é»
                        startPos = isNegRod ? getPlatePos(pair) : getLeafPos(pair);
                    }
                    
                    pair.electron.x = startPos.x; 
                    pair.electron.y = startPos.y; 
                    return;
                }

                // 2. è¨ˆç®—ç›®æ¨™ä½ç½®
                let p = pair.electron;
                let platePos = getPlatePos(pair);
                let leafPos = getLeafPos(pair);
                let targetPos = {x: 0, y: 0};

                if (this.contact.active || this.contact.hasContacted) {
                    // æ¥è§¸æ¨¡å¼ï¼šåˆ†çµ„å‡å‹»æ“´æ•£
                    let groupIndex = i % 4;
                    let goToPlate = (groupIndex < 2); 
                    targetPos = goToPlate ? platePos : leafPos;

                } else if (this.electroscope.isGrounded) {
                    // æ¥åœ°æ¨¡å¼
                    const releaseStart = 0.2;
                    if (strength >= releaseStart) {
                        targetPos = platePos;
                        if (Math.hypot(p.x - platePos.x, p.y - platePos.y) > 100 * s) {
                             p.x = platePos.x; p.y = platePos.y;
                        }
                    } else {
                        let progress = (releaseStart - strength) / releaseStart;
                        progress = Math.max(0, Math.min(1, progress));
                        let isDestinedForLeaf = (i % 3 !== 0);
                        let myTurn = (i / activeCount) < progress;
                        if (isDestinedForLeaf && myTurn) targetPos = leafPos; 
                        else targetPos = platePos; 
                    }
                } else {
                    // ä¸€èˆ¬æ„Ÿæ‡‰æ¨¡å¼
                    if (isNegRod) targetPos = leafPos; 
                    else targetPos = platePos;         
                }

                // 3. ç‰©ç†ç§»å‹• (Lane Logic)
                let laneOffset = ((pair.id % 5) - 2) * 1.5 * s;
                let laneX = cx + laneOffset;
                let rodTopY = plateY;
                let rodBottomY = pivotY;
                let goingDown = (targetPos.y > p.y + 10*s);
                let goingUp = (targetPos.y < p.y - 10*s);
                let nextX = p.x, nextY = p.y;

                if (goingDown) {
                    if (p.y < rodTopY + 5*s) { 
                        nextX = laneX; 
                        nextY = (Math.abs(p.x - cx) > 3.5 * s) ? rodTopY + 2 * s : p.y + 10*s; 
                        if (nextY > rodBottomY) nextY = rodBottomY;
                    } else if (p.y < rodBottomY - 5*s) {
                        nextX = laneX; nextY = rodBottomY;
                    } else {
                        nextX = targetPos.x; nextY = targetPos.y;
                    }
                } else if (goingUp) {
                    if (p.y > rodBottomY - 5*s) {
                        nextX = laneX; nextY = rodBottomY - 15*s; 
                    } else if (p.y > rodTopY + 5*s) {
                        nextX = laneX; nextY = rodTopY; 
                    } else {
                        nextX = targetPos.x; nextY = targetPos.y;
                    }
                } else {
                    nextX = targetPos.x; nextY = targetPos.y;
                }

                p.x += (nextX - p.x) * 0.25; 
                p.y += (nextY - p.y) * 0.25;

                // 4. è¦–è¦ºæ¸²æŸ“ (Visual Rendering) - ã€ä¿®æ”¹é‡é»ã€‘
                if (this.contact.active || this.contact.hasContacted) {
                    let showColor, hideColor;
                    if (isNegRod) {
                        showColor = 'electron'; hideColor = 'proton'; // æ£’è²  -> é¡¯é›»å­
                    } else {
                        showColor = 'proton'; hideColor = 'electron'; // æ£’æ­£ -> é¡¯è³ªå­
                    }

                    // A. é¡¯ç¤ºè‰² (Show Color)
                    pair[showColor].x = p.x; 
                    pair[showColor].y = p.y;
                    // å¹³æ»‘æ·¡å…¥ (Lerp): å¾ç›®å‰çš„ alpha æ…¢æ…¢åŠ åˆ° 1
                    pair[showColor].alpha += (1.0 - pair[showColor].alpha) * 0.2; 

                    // B. éš±è—è‰² (Hide Color) - ã€äº¤éŒ¯æ·¡åŒ–æ ¸å¿ƒã€‘
                    // ä¸è¦ç›´æ¥è¨­ç‚º 0ï¼Œè€Œæ˜¯æ…¢æ…¢æ¸›å° (Decay)
                    // ä¸¦ä¸”ï¼šå°‡å®ƒå€‘ã€Œé‡˜ã€åœ¨é‡‘å±¬ç›¤åŸæœ¬çš„ä½ç½®ï¼Œä¸è¦è®“å®ƒå€‘è·Ÿè‘— p è·‘
                    if (pair[hideColor].alpha > 0.01) {
                        pair[hideColor].alpha -= 0.1; // æ¯å¹€æ¸›å°‘ 10% é€æ˜åº¦ (ç´„ 10 å¹€æ¶ˆå¤±)
                        
                        // åªæœ‰åŸæœ¬åœ¨ç›¤å­ä¸Šçš„é‚£äº›(ç•°æ€§é›»)éœ€è¦é‡˜ä½ï¼Œé¿å…è·³å‹•
                        // é‡‘ç®”ä¸Šçš„æœ¬ä¾†å°±æ²’è®Šè‰²ï¼Œæ‰€ä»¥æ²’å·®
                        if (i % 4 < 2) { 
                             pair[hideColor].x = platePos.x;
                             pair[hideColor].y = platePos.y;
                        } else {
                             // é‡‘ç®”çš„å¯ä»¥ç›´æ¥éš±è—ï¼Œå› ç‚ºå®ƒå€‘ä½ç½®æœ¬ä¾†å°±é‡ç–Š
                             pair[hideColor].x = p.x;
                             pair[hideColor].y = p.y;
                        }
                    } else {
                        pair[hideColor].alpha = 0;
                    }

                } else if (this.electroscope.isGrounded) {
                    // æ¥åœ°æ¨¡å¼æ¸²æŸ“
                    let showColor = isNegRod ? 'proton' : 'electron';
                    let hideColor = isNegRod ? 'electron' : 'proton';
                    pair[showColor].x = p.x; pair[showColor].y = p.y;
                    pair[showColor].alpha = 1.0; pair[hideColor].alpha = 0;
                } else {
                    // ä¸€èˆ¬æ„Ÿæ‡‰æ¨¡å¼æ¸²æŸ“
                    let fade = Math.min(1, strength * 8);
                    if (isNegRod) {
                        pair.proton.x = platePos.x; pair.proton.y = platePos.y; 
                        pair.electron.x = p.x; pair.electron.y = p.y; 
                    } else {
                        pair.electron.x = p.x; pair.electron.y = p.y;
                        pair.proton.x = leafPos.x; pair.proton.y = leafPos.y;
                    }
                    pair.proton.alpha = fade;
                    pair.electron.alpha = fade;
                }
            });
        },

        updateInfoTag: function(strength) {
            const tag = document.getElementById('infoTag');
            let msg = "";
            let cls = "instruction-tag";
            
            if (this.electroscope.isGrounded) {
                if (strength > 0.2) {
                    msg = "æ­¥é©Ÿ3ï¼šè«‹ç§»é–‹å¸¶é›»æ£’";
                    cls += " highlight";
                } else {
                    // === ä¿®æ”¹é€™è£¡ ===
                    let cType = this.rod.charge < 0 ? "æ­£" : "è² "; 
                    // åœ¨çµæœå¾Œæ–¹åŠ ä¸Šæ“ä½œå¼•å°ï¼Œè®“ä½¿ç”¨è€…çŸ¥é“æ–°çš„åŠŸèƒ½
                    msg = `å¯¦é©—å®Œæˆï¼šå¸¶${cType}é›» (å†æ¬¡é»æ“Šæ¥åœ°æ­¸é›¶)`;
                    cls += " success";
                }
            } else {
                // ... (ä¸‹æ–¹é‚è¼¯ä¿æŒä¸è®Š)
                if (strength > 0.3) {
                    msg = "æ­¥é©Ÿ2ï¼šé»æ“Šã€Œæ¥åœ°ã€";
                    cls += " highlight";
                } else {
                    msg = "æ­¥é©Ÿ1ï¼šè«‹æ‹–æ›³å¸¶é›»æ£’é è¿‘é‡‘å±¬ç›¤";
                }
            }
            if(tag.innerText !== msg) tag.innerText = msg;
            tag.className = cls;
        },
		
		// ç”¨ä¾†æ§åˆ¶æ¥è§¸æŒ‰éˆ•çš„äº®/æ»…
        updateContactBtn: function() {
            const btn = document.getElementById('btnContact');
            
            // 1. å¦‚æœå·²ç¶“åœ¨æ¥è§¸ç‹€æ…‹(å¸é™„ä¸­)ï¼ŒæŒ‰éˆ•ä¿æŒé–‹å•Ÿ
            if (this.contact.active) {
                btn.disabled = false;
                return;
            }

            // 2. ç›´æ¥æª¢æŸ¥åº§æ¨™ï¼šé›»æ£’æ˜¯å¦å·²ç¶“åˆ°äº†è»Œé“çš„çµ‚é» (railEnd)ï¼Ÿ
            // æˆ‘å€‘å…è¨± 2 åƒç´ çš„å¾®å°èª¤å·®ï¼Œç¢ºä¿æ‹–åˆ°åº•æ™‚ä¸€å®šèƒ½è§¸ç™¼
            let dx = this.rod.x - this.config.railEnd.x;
            let dy = this.rod.y - this.config.railEnd.y;
            let distToLimit = Math.hypot(dx, dy);

            // 3. åˆ¤å®šï¼šè·é›¢å°æ–¼ 2px (ä»£è¡¨å·²ç¶“è²¼åœ¨æ¥µé™ä½ç½®äº†) ä¸” æœªæ¥åœ°
            let isAtLimit = (distToLimit < 2);
            
            if (isAtLimit && !this.electroscope.isGrounded) {
                btn.disabled = false;
                // è¨˜éŒ„æ­¤åˆ»çš„ä½ç½®ï¼Œé€™å°±æ˜¯æœ€å®Œç¾çš„ã€Œæœ€è¿‘ä½ç½®ã€
                this.contact.lastValidPos = { x: this.rod.x, y: this.rod.y };
            } else {
                btn.disabled = true;
            }
        },

        // å…ˆè£œä¸Šé€™å€‹ç©ºå‡½å¼ï¼Œé˜²æ­¢é»æ“Šæ™‚å ±éŒ¯
        toggleContact: function() {
            const btn = document.getElementById('btnContact');
            
            if (!this.contact.active) {
                // === å‹•ä½œï¼šå¸é™„ (ON) ===
                this.contact.active = true;
                btn.classList.add('active-contact');
                
                let s = this.config.globalScale * this.config.bottleSizeMult;
                let plateY = this.electroscope.y - 140 * s;
                
                // 1. è¨­å®šæ£’å­å¸é™„ä½ç½®
                this.rod.x = this.electroscope.x + 70 * s;
                this.rod.y = plateY - 10 * s; 
                
                // 2. é›»è·æ³¨å…¥ç‰¹æ•ˆ
                let isNegRod = (this.rod.charge < 0);
                
                this.particlePairs.forEach((pair, i) => {
                    let groupIndex = i % 4;
                    let isPlateGroup = (groupIndex < 2);

                    if (isPlateGroup) {
                        // ã€é—œéµä¿®æ­£ã€‘
                        // ä¸ç®¡æ˜¯é¡¯ç¤ºç´…çƒé‚„æ˜¯è—çƒï¼Œè² è²¬é‹ç®—çš„ã€Œç‰©ç†æœ¬é«” (pair.electron)ã€
                        // å¿…é ˆå¼·åˆ¶ç¬ç§»åˆ°æ£’å­å°–ç«¯ï¼Œé€™æ¨£è·¯å¾‘é‹ç®—æ‰æœƒå¾ä¸Šå¾€ä¸‹ç®—ï¼
                        pair.electron.x = this.rod.x;
                        pair.electron.y = this.rod.y;

                        // è¦–è¦ºæ›¿èº«ä¹Ÿè¦ä¸€èµ·å»ï¼Œé¿å…é–ƒçˆ
                        pair.proton.x = this.rod.x;
                        pair.proton.y = this.rod.y;
                        
                        // è™•ç†é€æ˜åº¦
                        let showColor = isNegRod ? 'electron' : 'proton';
                        pair[showColor].alpha = 1.0; 
                    }
                });

            } else {
                // === å‹•ä½œï¼šå½ˆå› (OFF) ===
                this.contact.active = false;
                btn.classList.remove('active-contact');
                
                if (this.contact.lastValidPos) {
                    this.rod.x = this.contact.lastValidPos.x;
                    this.rod.y = this.contact.lastValidPos.y;
                    
                    let s = this.config.globalScale * this.config.bottleSizeMult;
                    let plateY = this.electroscope.y - 140 * s;
                    this.rod.angle = Math.atan2(plateY - this.rod.y, this.electroscope.x - this.rod.x);
                }
            }
            
            this.draw();
        },

        draw: function() {
            this.ctx.clearRect(0, 0, this.width, this.height);
            let sBottle = this.config.globalScale * this.config.bottleSizeMult;
            let sRod = this.config.globalScale * this.config.rodSizeMult;
            
            this.drawElectroscope(sBottle);
            this.drawParticles(sBottle);
            this.drawRod(sRod);
        },

        drawElectroscope: function(s) {
            let ctx = this.ctx;
            let cx = this.electroscope.x;
            let cy = this.electroscope.y;

            let bottleTopW = 70 * s;
            let bottleBaseW = 200 * s;
            let bottleNeckH = 60 * s;
            let bottleBodyH = 200 * s;
            
            let plateY = cy - 140 * s;
            let bottleTopY = cy - 100 * s; 
            let bottleBottomY = bottleTopY + bottleNeckH + bottleBodyH;

            // ç“¶èº«
            ctx.beginPath();
            ctx.moveTo(cx - bottleTopW / 2, bottleTopY);
            ctx.lineTo(cx - bottleTopW / 2, bottleTopY + bottleNeckH);
            ctx.quadraticCurveTo(cx - bottleTopW / 2, bottleTopY + bottleNeckH + 30 * s, cx - bottleBaseW / 2, bottleBottomY - 20 * s);
            ctx.quadraticCurveTo(cx - bottleBaseW / 2, bottleBottomY, cx, bottleBottomY);
            ctx.quadraticCurveTo(cx + bottleBaseW / 2, bottleBottomY, cx + bottleBaseW / 2, bottleBottomY - 20 * s);
            ctx.quadraticCurveTo(cx + bottleTopW / 2, bottleTopY + bottleNeckH + 30 * s, cx + bottleTopW / 2, bottleTopY + bottleNeckH);
            ctx.lineTo(cx + bottleTopW / 2, bottleTopY);
            ctx.closePath();
            ctx.fillStyle = "rgba(220, 245, 255, 0.3)"; ctx.fill();
            ctx.lineWidth = 2 * s; ctx.strokeStyle = "rgba(100, 120, 140, 0.8)"; ctx.stroke();

            // æ©¡çš®å¡
            ctx.fillStyle = "#34495e";
            ctx.beginPath(); ctx.rect(cx - bottleTopW/2 - 2*s, bottleTopY - 10*s, bottleTopW + 4*s, 15*s); ctx.fill();

            // é‡‘å±¬æ¡¿
            let rodBottomY = cy + 60 * s; 
            ctx.fillStyle = "#bdc3c7";
            ctx.fillRect(cx - 4 * s, plateY, 8 * s, rodBottomY - plateY);

            // é‡‘å±¬ç›¤
            ctx.beginPath(); ctx.ellipse(cx, plateY, 60 * s, 10 * s, 0, 0, Math.PI * 2);
            ctx.fillStyle = "#95a5a6"; ctx.fill();
            ctx.lineWidth = 1 * s; ctx.strokeStyle = "#7f8c8d"; ctx.stroke();

            // é‡‘ç®”
            let angle = this.electroscope.leafAngle;
            let leafL = this.config.leafLengthBase * s; 
            let leafW = 6 * s;
            
            ctx.save();
            ctx.translate(cx, rodBottomY);
            ctx.save(); ctx.rotate(-angle); ctx.fillStyle = "#f1c40f"; ctx.fillRect(-leafW, 0, leafW, leafL); ctx.restore();
            ctx.save(); ctx.rotate(angle); ctx.fillStyle = "#f1c40f"; ctx.fillRect(0, 0, leafW, leafL); ctx.restore();
            ctx.restore();
        },

        drawParticles: function(s) {
            let r = this.config.particleRadius * s;

            this.particlePairs.forEach(pair => {
                if (pair.proton.alpha > 0.05) {
                    this.ctx.globalAlpha = pair.proton.alpha;
                    this.drawOneParticle(pair.proton.x, pair.proton.y, r, '#e74c3c', '+');
                }
                if (pair.electron.alpha > 0.05) {
                    this.ctx.globalAlpha = pair.electron.alpha;
                    this.drawOneParticle(pair.electron.x, pair.electron.y, r, '#3498db', '-');
                }
            });
            this.ctx.globalAlpha = 1.0;
        },

        drawOneParticle: function(x, y, r, color, sym) {
            this.ctx.beginPath(); 
            this.ctx.arc(x, y, r, 0, Math.PI*2);
            this.ctx.fillStyle = "white"; 
            this.ctx.fill();
            this.ctx.strokeStyle = color; 
            this.ctx.lineWidth = 1.5; 
            this.ctx.stroke();
            if (r > 3) {
                this.ctx.fillStyle = color; 
                this.ctx.font = `bold ${r*1.5}px Arial`;
                this.ctx.textAlign = "center"; 
                this.ctx.textBaseline = "middle"; 
                this.ctx.fillText(sym, x, y+1);
            }
        },

        drawRod: function(s) {
            this.ctx.save();
            this.ctx.translate(this.rod.x, this.rod.y);
            this.ctx.rotate(this.rod.angle);
            
            let L = 130 * s; 
            let W = 36 * s;
            let color = this.rod.charge < 0 ? '#3498db' : '#e74c3c';
            let sym = this.rod.charge < 0 ? "-" : "+";

            this.ctx.fillStyle = "#34495e";
            this.ctx.fillRect(-L/2, -W/2, L, W);

            let headX = L/2 - W/2;
            let headR = W * 0.85;
            this.ctx.beginPath(); 
            this.ctx.arc(headX, 0, headR, 0, Math.PI*2);
            this.ctx.fillStyle = "#fff"; this.ctx.fill();
            this.ctx.lineWidth = 4; this.ctx.strokeStyle = color; this.ctx.stroke();
            
            this.ctx.fillStyle = color; 
            this.ctx.font = "bold 24px Arial";
            this.ctx.textAlign = "center"; 
            this.ctx.textBaseline = "middle";
            this.ctx.fillText(sym, headX, 2);
            
            this.ctx.restore();
        },

        setRod: function(c) {
            this.rod.charge = c;
            this.hardReset(); 
            document.getElementById('btnNeg').className = c===-1 ? 'btn-toggle active-neg' : 'btn-toggle';
            document.getElementById('btnPos').className = c===1 ? 'btn-toggle active-pos' : 'btn-toggle';
        },

        handleMouse: function(e) { e.type==='mousedown'?this.startDrag(e):e.type==='mousemove'?this.drag(e):this.endDrag(); },
        handleTouch: function(e) { e.preventDefault(); e.type==='touchstart'?this.startDrag(e):e.type==='touchmove'?this.drag(e):this.endDrag(); },
        getPos: function(e) {
            const rect = this.canvas.getBoundingClientRect();
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let cy = e.touches ? e.touches[0].clientY : e.clientY;
            return {x: cx - rect.left, y: cy - rect.top};
        },
        startDrag: function(e) {
            let p = this.getPos(e);
            let dist = Math.hypot(p.x - this.rod.x, p.y - this.rod.y);
            if(dist < 200) this.rod.dragging = true;
            if(this.rod.dragging) this.drag(e);
        },
        drag: function(e) {
            if (this.contact.active) return;
			if(!this.rod.dragging) return;
            let p = this.getPos(e);
            let A = this.config.railStart;
            let B = this.config.railEnd;
            let P = p;
            let abX = B.x - A.x; let abY = B.y - A.y;
            let apX = P.x - A.x; let apY = P.y - A.y;
            let t = (apX*abX + apY*abY) / (abX*abX + abY*abY);
            t = Math.max(0, Math.min(1, t));
            this.rod.x = A.x + abX * t;
            this.rod.y = A.y + abY * t;
            let s = this.config.globalScale * this.config.bottleSizeMult;
            let plateY = this.electroscope.y - 140 * s;
            this.rod.angle = Math.atan2(plateY - this.rod.y, this.electroscope.x - this.rod.x);
        },
        endDrag: function() { this.rod.dragging = false; },
        loop: function() { this.update(); this.draw(); requestAnimationFrame(() => this.loop()); }
    };
    window.onload = () => APP.init();
    </script>
</body>
</html>